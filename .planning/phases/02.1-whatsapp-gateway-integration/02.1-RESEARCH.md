# Phase 2.1: WhatsApp Gateway Integration - Research

**Researched:** 2026-01-25
**Domain:** WhatsApp automation via local gateway using whatsapp-web.js
**Confidence:** HIGH

## Summary

Phase 2.1 leverages existing WhatsApp gateway infrastructure that's already 90% complete. The core challenge is transitioning from "partially working" to "production reliable" by addressing known failure modes (frame detachment, session persistence, error visibility) and establishing clear manager workflows.

The existing architecture follows a **local gateway pattern**: a Node.js Express server runs on the manager's machine, using whatsapp-web.js (Puppeteer-based WhatsApp Web automation) to handle message sending. The main Render-hosted application communicates with this gateway via HTTP. This separation exists because whatsapp-web.js requires a persistent browser session and local file storage for authentication - both incompatible with serverless hosting.

**Key findings:**
- whatsapp-web.js v1.34.4 with LocalAuth is the standard for single-instance WhatsApp automation
- Frame detachment errors (already fixed) were the primary reliability issue
- Session persistence via `.wwebjs_auth` eliminates QR re-scanning
- Clear error messaging is critical - WhatsApp failures must not appear as successes

**Primary recommendation:** Focus on manager UX (startup simplicity, error clarity, status visibility) and verification workflows rather than new features. The technical foundation is solid.

## Standard Stack

The established libraries/tools for WhatsApp automation in Node.js:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| whatsapp-web.js | 1.34.4 | WhatsApp Web automation | Most popular unofficial WhatsApp library, uses Puppeteer to automate WhatsApp Web interface |
| express | 5.2.1 | REST API gateway | Industry standard for Node.js HTTP servers, simple and battle-tested |
| puppeteer | (bundled) | Browser automation | Bundled with whatsapp-web.js, handles Chrome automation for WhatsApp Web |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| qrcode-terminal | 0.12.0 | Terminal QR display | Initial authentication - shows QR in console for scanning |
| cors | 2.8.5 | Cross-origin requests | Allow Render server to call local gateway API |
| dotenv | 16.4.7 | Environment config | Store WHATSAPP_GATEWAY_URL for Render deployment |
| axios | (in main server) | HTTP client | Make requests from Render server to local gateway |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| whatsapp-web.js | Baileys | Baileys uses WhatsApp's mobile protocol (more detection risk), whatsapp-web.js mimics browser (lower risk) |
| whatsapp-web.js | Official WhatsApp API | Official API costs money and requires Meta Business verification; whatsapp-web.js is free but unofficial (ban risk) |
| LocalAuth | RemoteAuth | RemoteAuth for distributed systems; LocalAuth simpler for single-machine use case |

**Installation:**
```bash
# Already installed in whatsapp-gateway/
cd whatsapp-gateway
npm install
```

## Architecture Patterns

### Recommended Project Structure
```
whatsapp-gateway/          # Standalone Node.js server
â”œâ”€â”€ index.js               # Express server + whatsapp-web.js client
â”œâ”€â”€ package.json           # Gateway dependencies
â”œâ”€â”€ .wwebjs_auth/          # Session storage (DO NOT DELETE)
â”‚   â””â”€â”€ session-*/         # Persisted WhatsApp session
â””â”€â”€ .env                   # Optional config

server/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ whatsapp.js        # Gateway client (HTTP wrapper)
â””â”€â”€ routes/
    â””â”€â”€ whatsapp.js        # API endpoints for main app
```

### Pattern 1: Local Gateway Separation
**What:** Run WhatsApp client as separate local process, not in main application
**When to use:** WhatsApp automation requires persistent browser + file storage (incompatible with serverless hosting)
**Architecture:**
```
[Manager's Machine]                    [Render Cloud]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WhatsApp Gateway    â”‚â—„â”€â”€â”€ HTTP â”€â”€â”€â”€â”€â”‚ Main Server  â”‚
â”‚ (Express on :3003)  â”‚               â”‚ (Express)    â”‚
â”‚                     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ whatsapp-web.js â”‚ â”‚
â”‚ â”‚   (Puppeteer)   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²           â”‚
â”‚         â”‚ QR scan   â”‚
â”‚         â–¼           â”‚
â”‚   WhatsApp Web      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**
```javascript
// whatsapp-gateway/index.js
const { Client, LocalAuth } = require('whatsapp-web.js');

const client = new Client({
  authStrategy: new LocalAuth({
    clientId: 'eden-whatsapp-local'
  }),
  puppeteer: {
    headless: false,  // Show browser for debugging
    args: ['--no-sandbox']
  }
});

// server/services/whatsapp.js (gateway client)
class WhatsAppService {
  constructor() {
    this.gatewayUrl = process.env.WHATSAPP_GATEWAY_URL || 'http://192.168.1.35:3003';
  }

  async sendMessage(phoneNumber, message) {
    const response = await axios.post(`${this.gatewayUrl}/send`,
      { phoneNumber, message },
      { timeout: 30000 }
    );
    return response.data;
  }
}
```

### Pattern 2: State Management for Browser Automation
**What:** Track client state (initializing, ready, disconnected) separately from process state
**When to use:** Browser automation has multiple async initialization phases before being usable
**Anti-pattern:** Checking `if (client)` is insufficient - client object exists during initialization but isn't ready

**Implementation:**
```javascript
// Source: Existing whatsapp-gateway/index.js (lines 14-62)
let client = null;
let isReady = false;
let qrCode = null;

client.on('qr', (qr) => {
  qrCode = qr;
  isReady = false;  // QR means not authenticated yet
});

client.on('ready', () => {
  isReady = true;
  qrCode = null;
});

client.on('disconnected', (reason) => {
  isReady = false;
  client = null;  // Force re-initialization
});

// API checks isReady, not just client existence
app.post('/send', async (req, res) => {
  if (!isReady) {
    return res.status(400).json({
      error: 'WhatsApp is not ready. Please authenticate first.'
    });
  }
  // ... send logic
});
```

### Pattern 3: Phone Number Normalization
**What:** Convert user input to WhatsApp's required format (country code + number + @c.us)
**When to use:** Any phone number handling for WhatsApp
**Why needed:** WhatsApp requires `972XXXXXXXXX@c.us` format; users enter `05X-XXX-XXXX`

**Implementation:**
```javascript
// Source: whatsapp-gateway/index.js (lines 99-107)
function formatPhoneNumber(phoneNumber) {
  // Remove non-digits
  let formatted = phoneNumber.replace(/\D/g, '');

  // Add Israel country code if missing
  if (!formatted.startsWith('972')) {
    formatted = '972' + formatted.replace(/^0+/, '');
  }

  return `${formatted}@c.us`;
}

// Usage
const chatId = formatPhoneNumber('050-123-4567');  // -> '972501234567@c.us'
await client.sendMessage(chatId, message);
```

### Anti-Patterns to Avoid

- **Assuming client initialization is synchronous:** The `client.initialize()` call returns immediately, but WhatsApp isn't ready until the `ready` event fires (can take 5-30 seconds after QR scan)

- **Not handling frame detachment:** Puppeteer frames can detach during long-running sessions. Always catch errors and check for "detached Frame" string to reset client state (already implemented in existing code)

- **Sharing session across instances:** The `.wwebjs_auth` directory locks to one client. Running multiple instances with same `clientId` causes authentication conflicts

- **Not validating gateway availability before bulk operations:** Check `/status` endpoint before sending 20 messages to avoid partial failures

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| WhatsApp message sending | Custom WhatsApp protocol client | whatsapp-web.js | WhatsApp's protocol is proprietary, encrypted, and changes frequently. Reverse-engineering it is a full-time job. whatsapp-web.js team maintains compatibility. |
| QR code terminal display | ASCII art generator + terminal escape codes | qrcode-terminal | Handles terminal size detection, color support checking, and Unicode rendering edge cases across Windows/Mac/Linux |
| Session persistence | Manual cookie/localStorage management | LocalAuth strategy | WhatsApp uses complex multi-device authentication with encryption keys. LocalAuth handles key storage, rotation, and validation. |
| Phone number validation | Regex patterns | Normalize then validate format | International phone numbers have 100+ country-specific rules. Start simple (remove non-digits, add country code) rather than comprehensive validation library. |
| Browser automation | Raw Chrome DevTools Protocol | Puppeteer (bundled) | CDP is low-level and verbose. Puppeteer provides high-level API with frame management, navigation waiting, and error recovery. |

**Key insight:** WhatsApp automation is inherently fragile because it relies on reverse-engineering WhatsApp Web's internal JavaScript. Don't add fragility by also reverse-engineering the automation tooling. Use established libraries that have communities handling WhatsApp's frequent updates.

## Common Pitfalls

### Pitfall 1: Frame Detachment Crashes
**What goes wrong:** After hours/days of running, WhatsApp client stops sending messages with error "Attempted to use detached Frame". UI shows success but messages don't deliver.

**Why it happens:** Puppeteer's browser frames can detach during page reloads, memory pressure, or WhatsApp Web updates. The client object still exists and `isReady` stays true, but the underlying browser frame is unusable.

**How to avoid:**
```javascript
// Detect frame errors and reset client state
try {
  await client.sendMessage(chatId, message);
} catch (error) {
  if (error.message.includes('detached Frame')) {
    console.error('Frame detached - client is broken');
    isReady = false;  // Prevent further sends
    await client.destroy();
    client = null;  // Force re-init
    throw new Error('×—×™×‘×•×¨ WhatsApp ×”×ª× ×ª×§. ×™×© ×œ×”×ª×—×‘×¨ ×ž×—×“×© ×“×¨×š ×”×”×’×“×¨×•×ª');
  }
  throw error;
}
```

**Warning signs:**
- Logs show "Error: Attempted to use detached Frame"
- UI reports success but messages don't arrive
- WhatsApp browser window becomes unresponsive

**Status:** Already fixed in existing codebase (see `.planning/debug/resolved/whatsapp-delivery-failure.md`)

### Pitfall 2: Session Persistence Fails on Ephemeral File Systems
**What goes wrong:** QR code required on every startup, even though LocalAuth is configured

**Why it happens:** LocalAuth writes session data to `.wwebjs_auth/` directory. If file system is ephemeral (Heroku, some Docker configs), this directory is wiped on restart.

**How to avoid:**
- Use persistent file systems only (local machines, VPS with persistent volumes)
- Verify `.wwebjs_auth/` directory exists and is not in `.gitignore` exclusions
- For this project: Gateway runs on manager's local Windows machine (persistent by default)

**Warning signs:**
- QR code shown every time gateway starts
- `.wwebjs_auth/` directory empty or missing
- Logs show "Generating QR code" even after previous authentication

### Pitfall 3: Silent Gateway Failures
**What goes wrong:** Main server reports "Messages sent successfully" but employees don't receive anything

**Why it happens:**
1. Gateway not running (connection refused)
2. Gateway running but WhatsApp not authenticated (returns 400 error)
3. Network error between Render and gateway
4. Error caught but not properly propagated to UI

**How to avoid:**
```javascript
// server/services/whatsapp.js
async sendMessage(phoneNumber, message) {
  try {
    const response = await axios.post(`${this.gatewayUrl}/send`, ...);
    return { success: true };
  } catch (error) {
    // Distinguish error types for user-friendly messages
    if (error.code === 'ECONNREFUSED') {
      throw new Error('×©×¨×ª WhatsApp ×”×ž×§×•×ž×™ ××™× ×• ×–×ž×™×Ÿ - ×•×•×“× ×©×”×©×¨×ª ×¨×¥ ×¢×œ ×”×ž×—×©×‘ ×©×œ×š');
    } else if (error.response?.status === 400) {
      throw new Error('×•×•××˜×¡××¤ ××™× ×• ×ž×—×•×‘×¨. ×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×“×¨×š ×”×”×’×“×¨×•×ª');
    } else {
      throw new Error('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”: ' + (error.response?.data?.error || error.message));
    }
  }
}
```

**Warning signs:**
- UI success message but no WhatsApp delivery
- Console logs show axios errors with generic messages
- Users report "not receiving messages" but no error shown in app

### Pitfall 4: QR Code Timeout Race Condition
**What goes wrong:** User clicks "Connect WhatsApp" but QR code never appears, or shows briefly then disappears

**Why it happens:** WhatsApp Web generates QR codes that expire after ~60 seconds. If client initialization is slow or network unstable, the QR might expire before user can scan it.

**How to avoid:**
- Don't fetch QR code immediately - wait for `qr` event
- Store QR in variable and serve via endpoint (pattern already used)
- Allow re-requesting QR without full client restart
- Set realistic timeout expectations in UI (e.g., "QR expires in 60 seconds, click Refresh if needed")

**Warning signs:**
- Logs show "QR CODE RECEIVED" but `/qr` endpoint returns 404
- User clicks connect, waits 2 minutes, sees nothing
- Multiple `qr` events fired in quick succession

### Pitfall 5: Headless Mode Hiding Errors
**What goes wrong:** WhatsApp client initialization fails silently in headless mode, no visible indication of what went wrong

**Why it happens:** In headless mode (`headless: true`), Puppeteer browser runs without UI. If WhatsApp Web shows an error page or unexpected prompt, you can't see it.

**How to avoid:**
- Use `headless: false` during development and troubleshooting (current config)
- Add extensive logging around client initialization
- Implement timeout for `ready` event (if not ready in 120s, something is wrong)
- Consider keeping headless: false for production since this is local gateway (browser window provides visual confirmation)

**Warning signs:**
- Client initialization hangs forever
- No `ready` event after QR scan
- Browser appears to be running but nothing happens

## Code Examples

Verified patterns from official sources and existing codebase:

### Gateway Server Initialization
```javascript
// Source: whatsapp-gateway/index.js (simplified)
const express = require('express');
const { Client, LocalAuth } = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');

const app = express();
app.use(express.json());
app.use(cors());

let client = null;
let isReady = false;
let qrCode = null;

async function initializeWhatsApp() {
  client = new Client({
    authStrategy: new LocalAuth({
      clientId: 'eden-whatsapp-local'  // Unique ID for session isolation
    }),
    puppeteer: {
      headless: false,  // Show browser for debugging
      args: ['--no-sandbox']  // Required for some Linux environments
    }
  });

  client.on('qr', (qr) => {
    console.log('ðŸ“± QR CODE RECEIVED - Scan with your phone:');
    qrcode.generate(qr, { small: true });  // Display in terminal
    qrCode = qr;  // Store for API endpoint
    isReady = false;
  });

  client.on('ready', () => {
    console.log('âœ… WhatsApp client is ready!');
    isReady = true;
    qrCode = null;
  });

  client.on('authenticated', () => {
    console.log('âœ… WhatsApp authenticated successfully');
  });

  client.on('disconnected', (reason) => {
    console.log('âŒ WhatsApp disconnected:', reason);
    isReady = false;
    client = null;
  });

  await client.initialize();
}

app.listen(3003, '0.0.0.0', async () => {
  console.log('ðŸš€ Server running on port 3003');
  await initializeWhatsApp();
});
```

### Status Check Endpoint
```javascript
// Source: whatsapp-gateway/index.js (lines 66-73)
app.get('/status', (req, res) => {
  res.json({
    isReady,              // Can send messages right now
    hasQR: qrCode !== null,  // QR available for scanning
    isInitialized: client !== null  // Client object exists
  });
});
```

### Send Message with Error Handling
```javascript
// Source: whatsapp-gateway/index.js (lines 86-120)
app.post('/send', async (req, res) => {
  try {
    const { phoneNumber, message } = req.body;

    if (!phoneNumber || !message) {
      return res.status(400).json({
        error: 'Phone number and message are required'
      });
    }

    if (!isReady) {
      return res.status(400).json({
        error: 'WhatsApp is not ready. Please authenticate first.'
      });
    }

    // Format phone number for WhatsApp
    let formattedNumber = phoneNumber.replace(/\D/g, '');
    if (!formattedNumber.startsWith('972')) {
      formattedNumber = '972' + formattedNumber.replace(/^0+/, '');
    }
    const chatId = `${formattedNumber}@c.us`;

    console.log(`ðŸ“¤ Sending message to ${chatId}...`);
    await client.sendMessage(chatId, message);

    console.log('âœ… Message sent successfully');
    res.json({ success: true });
  } catch (error) {
    console.error('âŒ Error sending message:', error);
    res.status(500).json({ error: error.message });
  }
});
```

### Gateway Client (Main Server Side)
```javascript
// Source: server/services/whatsapp.js
const axios = require('axios');

class WhatsAppService {
  constructor() {
    this.gatewayUrl = process.env.WHATSAPP_GATEWAY_URL || 'http://192.168.1.35:3003';
  }

  async getStatus() {
    try {
      const response = await axios.get(`${this.gatewayUrl}/status`, {
        timeout: 5000
      });
      return {
        isReady: response.data.isReady,
        needsAuth: response.data.hasQR,
        isInitialized: response.data.isInitialized
      };
    } catch (error) {
      return {
        isReady: false,
        error: 'Gateway not reachable - make sure WhatsApp gateway is running on your computer'
      };
    }
  }

  async sendMessage(phoneNumber, message) {
    try {
      const response = await axios.post(
        `${this.gatewayUrl}/send`,
        { phoneNumber, message },
        { timeout: 30000 }  // 30s timeout for message send
      );

      if (response.data.success) {
        return { success: true };
      } else {
        throw new Error('Gateway returned non-success response');
      }
    } catch (error) {
      if (error.code === 'ECONNREFUSED') {
        throw new Error('×©×¨×ª WhatsApp ×”×ž×§×•×ž×™ ××™× ×• ×–×ž×™×Ÿ - ×•×•×“× ×©×”×©×¨×ª ×¨×¥ ×¢×œ ×”×ž×—×©×‘ ×©×œ×š');
      } else {
        throw new Error(error.response?.data?.error || '×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”');
      }
    }
  }
}

module.exports = new WhatsAppService();
```

### Bulk Send with Delay
```javascript
// Source: whatsapp-gateway/index.js (lines 122-162)
app.post('/send-bulk', async (req, res) => {
  const { messages } = req.body;  // Array of { phoneNumber, message }

  if (!isReady) {
    return res.status(400).json({
      error: 'WhatsApp is not ready. Please authenticate first.'
    });
  }

  const results = [];

  for (const { phoneNumber, message } of messages) {
    try {
      let formattedNumber = phoneNumber.replace(/\D/g, '');
      if (!formattedNumber.startsWith('972')) {
        formattedNumber = '972' + formattedNumber.replace(/^0+/, '');
      }
      const chatId = `${formattedNumber}@c.us`;

      await client.sendMessage(chatId, message);
      results.push({ phoneNumber, success: true });

      // Small delay between messages to avoid rate limiting
      await new Promise(resolve => setTimeout(resolve, 1000));
    } catch (error) {
      results.push({ phoneNumber, success: false, error: error.message });
    }
  }

  res.json({ success: true, results });
});
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| whatsapp-web.js on Render | whatsapp-web.js on local gateway | Dec 2025 | Moved to local due to Render's serverless incompatibility with browser automation and persistent file storage |
| Multiple auth strategies tried | LocalAuth only | Dec 2025 | Simplified to single reliable strategy after RemoteAuth/NoAuth experiments failed |
| headless: true | headless: false | Jan 2026 | Visible browser helps debug frame detachment and provides visual confirmation of WhatsApp state |
| Silent error handling | Explicit Hebrew error messages | Jan 2026 | Manager sees clear error text instead of generic "something went wrong" |

**Deprecated/outdated:**
- **RemoteAuth with cloud storage:** Attempted but unreliable on Render's serverless architecture. LocalAuth with local file storage is simpler and more reliable for single-manager use case.
- **Localtunnel for gateway exposure:** Mentioned in KNOWN_ISSUES.md as "unstable hybrid architecture". Not needed if main server directly accesses gateway via local network IP.
- **Button/List messages:** WhatsApp deprecated these message types. Use plain text with URLs instead.

## Open Questions

Things that couldn't be fully resolved:

1. **Long-term session stability**
   - What we know: LocalAuth persists sessions across restarts; GitHub issues report some users experience disconnection after 2-3 days
   - What's unclear: Is 2-3 day disconnection consistent, or edge case? Does it apply to this version (1.34.4)?
   - Recommendation: Monitor in production. If disconnections occur, implement auto-reconnect with notification to manager to re-scan QR. Don't over-engineer for unconfirmed problem.

2. **WhatsApp ban risk assessment**
   - What we know: whatsapp-web.js uses unofficial automation; WhatsApp terms prohibit bots; library mimics browser to reduce detection
   - What's unclear: Actual ban rate for low-volume business use (1 manager sending ~20 messages/day to employees)
   - Recommendation: Document ban risk in user-facing docs. Have fallback plan (manual WhatsApp sending) if account is banned. Consider using dedicated WhatsApp number just for Eden system.

3. **Network accessibility between Render and local gateway**
   - What we know: Current config uses local network IP (`192.168.1.35:3003`) stored in Render env var
   - What's unclear: How manager's home network router/firewall handles incoming requests from Render cloud; whether NAT traversal or port forwarding is needed
   - Recommendation: Test actual connectivity from Render to local gateway during implementation. If local network IP doesn't work, explore ngrok/localtunnel as alternatives (despite "unstable" note in KNOWN_ISSUES, may be acceptable for MVP).

4. **Browser resource consumption on manager's machine**
   - What we know: Puppeteer runs full Chrome instance with WhatsApp Web
   - What's unclear: Actual CPU/memory usage over extended periods (days/weeks); whether it impacts manager's other work
   - Recommendation: Measure resource usage during testing. Document minimum system requirements. Consider adding "restart gateway" command if memory leaks occur.

5. **Message delivery confirmation**
   - What we know: whatsapp-web.js `sendMessage()` resolves when message is sent to WhatsApp servers, not when delivered/read
   - What's unclear: Whether library exposes delivery/read receipts; whether employees need to confirm receipt via separate mechanism
   - Recommendation: Review whatsapp-web.js docs for message status events. Phase 2.1 focuses on reliable sending; delivery tracking can be future enhancement.

## Sources

### Primary (HIGH confidence)
- [whatsapp-web.js official guide](https://wwebjs.dev/guide/) - Architecture overview, core concepts
- [whatsapp-web.js authentication docs](https://wwebjs.dev/guide/creating-your-bot/authentication) - LocalAuth strategy, session persistence
- [whatsapp-web.js GitHub repository](https://github.com/pedroslopez/whatsapp-web.js) - Current version (1.34.4), requirements (Node 18+), known limitations
- [Express.js error handling documentation](https://expressjs.com/en/guide/error-handling.html) - Official error middleware patterns
- Existing codebase files:
  - `whatsapp-gateway/index.js` - Complete gateway implementation
  - `server/services/whatsapp.js` - Gateway client
  - `server/routes/whatsapp.js` - API endpoints
  - `.planning/debug/resolved/whatsapp-delivery-failure.md` - Frame detachment fix
  - `.planning/KNOWN_ISSUES.md` - Historical context on WhatsApp challenges

### Secondary (MEDIUM confidence)
- [Best Practices and Troubleshooting | pedroslopez/whatsapp-web.js](https://deepwiki.com/pedroslopez/whatsapp-web.js/9-best-practices-and-troubleshooting) - Error handling, memory management
- [Express Error Handling Patterns | Better Stack Community](https://betterstack.com/community/guides/scaling-nodejs/error-handling-express/) - Centralized middleware, async/await patterns
- [Building an API Gateway using Node.js - RisingStack](https://blog.risingstack.com/building-an-api-gateway-using-nodejs/) - Gateway pattern architecture
- [Axios timeout configuration guide](https://www.zenrows.com/blog/axios-retry) - Timeout best practices, retry strategies

### Tertiary (LOW confidence - WebSearch only)
- GitHub issues on session persistence ([#2164](https://github.com/pedroslopez/whatsapp-web.js/issues/2164), [#2231](https://github.com/pedroslopez/whatsapp-web.js/issues/2231), [#3224](https://github.com/pedroslopez/whatsapp-web.js/issues/3224)) - Community reports of 2-3 day disconnections (needs validation in this context)
- Puppeteer frame detachment issues ([#11515](https://github.com/puppeteer/puppeteer/issues/11515), [#12294](https://github.com/puppeteer/puppeteer/issues/12294)) - Confirms frame detachment is known Puppeteer issue, multiple browser launch args suggested

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - whatsapp-web.js is dominant library, versions verified from package.json and GitHub
- Architecture: HIGH - Local gateway pattern is operational in existing code, patterns extracted from working implementation
- Pitfalls: HIGH - Frame detachment already debugged and fixed; other pitfalls documented in official guides
- Long-term stability: MEDIUM - Session persistence works but some users report issues; needs monitoring

**Research date:** 2026-01-25
**Valid until:** 2026-02-25 (30 days - whatsapp-web.js is stable, WhatsApp Web updates infrequent)

**Note:** This phase is unusual in that most technical work is already complete. Research focused on understanding existing implementation, verifying it follows best practices, and identifying gaps in manager UX and error handling rather than discovering new technical approaches.
