# Phase 2.1: Server-Integrated WhatsApp - Research

**Researched:** 2026-01-26
**Domain:** WhatsApp Web Integration via whatsapp-web.js + Socket.IO
**Confidence:** HIGH

## Summary

This phase integrates the existing WhatsApp gateway code (currently in `whatsapp-gateway/`) directly into the main Express server. The current system uses a separate gateway process that the server communicates with via HTTP. The new architecture moves the whatsapp-web.js client INTO the main server process, enabling persistent connection as long as the server runs.

The key architectural change is from a two-process model (server -> gateway via HTTP) to a single-process model (server with embedded WhatsApp client). The existing code in `whatsapp-gateway/index.js` provides a working implementation that can be adapted. The main additions are: (1) Socket.IO for real-time QR code delivery to browser, (2) session persistence via LocalAuth to .wwebjs_auth directory, and (3) a disconnect button in the Settings page UI.

The system already has Socket.IO integrated (`socket.io` 4.8.3) and whatsapp-web.js (`1.34.4`) in package.json. The primary work is refactoring the gateway code into a service, adding Socket.IO events for QR/status updates, and updating the Settings page UI.

**Primary recommendation:** Move `whatsapp-gateway/index.js` code into `server/services/whatsapp.js`, use Socket.IO to push QR codes to browser, and add disconnect button to Settings page.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| whatsapp-web.js | 1.34.4 | WhatsApp Web client via Puppeteer | Already in use, only viable option for WhatsApp Web automation |
| socket.io | 4.8.3 | Real-time bidirectional communication | Already integrated in server for task updates |
| LocalAuth | (part of whatsapp-web.js) | Session persistence to filesystem | Built-in, stores in .wwebjs_auth directory |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| qrcode | latest | Generate QR code as data URL (base64) | Convert QR string to image for browser display |
| puppeteer | bundled | Browser automation for WhatsApp Web | Bundled with whatsapp-web.js, no separate install |

### Already Present (no installation needed)
- whatsapp-web.js: 1.34.4 (in root package.json)
- socket.io: 4.8.3 (in root package.json)
- qrcode-terminal: 0.12.0 (terminal display, NOT for browser)

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| LocalAuth | RemoteAuth | RemoteAuth stores in MongoDB/S3 - overkill for single-manager system |
| Socket.IO for QR | HTTP polling | Already using Socket.IO, real-time is better UX |
| External QR API | qrcode npm | External API has latency, local generation is instant |

**Installation:**
```bash
npm install qrcode
```

Note: Only `qrcode` needs to be added. The current system uses an external API (`api.qrserver.com`) for QR rendering which adds latency. Local generation is faster and more reliable.

## Architecture Patterns

### Recommended Project Structure
```
server/
├── services/
│   └── whatsapp.js       # WhatsApp client singleton with Socket.IO integration
├── routes/
│   └── whatsapp.js       # HTTP endpoints (status, connect, disconnect, send)
└── index.js              # Initializes WhatsApp service, passes io instance
```

### Pattern 1: Singleton WhatsApp Client with Socket.IO Events
**What:** Single WhatsApp client instance that emits events to connected browsers via Socket.IO
**When to use:** Always - this is the core pattern for the phase

**Example:**
```javascript
// Source: Adapted from whatsapp-gateway/index.js + Socket.IO pattern
const { Client, LocalAuth } = require('whatsapp-web.js');
const QRCode = require('qrcode');

class WhatsAppService {
  constructor() {
    this.client = null;
    this.isReady = false;
    this.qrCode = null;
    this.io = null;
  }

  setIo(io) {
    this.io = io;
  }

  async initialize() {
    this.client = new Client({
      authStrategy: new LocalAuth({
        clientId: 'eden-whatsapp',
        dataPath: './.wwebjs_auth'
      }),
      puppeteer: {
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-gpu'
        ]
      }
    });

    // Emit QR to all connected browsers
    this.client.on('qr', async (qr) => {
      this.qrCode = qr;
      this.isReady = false;

      // Generate QR as data URL for browser display
      const qrDataUrl = await QRCode.toDataURL(qr);

      if (this.io) {
        this.io.emit('whatsapp:qr', { qrDataUrl });
      }
    });

    this.client.on('ready', () => {
      this.isReady = true;
      this.qrCode = null;

      if (this.io) {
        this.io.emit('whatsapp:ready');
      }
    });

    this.client.on('disconnected', (reason) => {
      this.isReady = false;
      this.client = null;

      if (this.io) {
        this.io.emit('whatsapp:disconnected', { reason });
      }
    });

    await this.client.initialize();
  }
}
```

### Pattern 2: HTTP + Socket.IO Hybrid API
**What:** HTTP endpoints for actions (connect, disconnect, send), Socket.IO for real-time updates
**When to use:** Standard pattern - HTTP for request/response, WebSocket for push updates

**Endpoints:**
- `GET /api/whatsapp/status` - Current connection status
- `POST /api/whatsapp/connect` - Start connection (triggers QR generation)
- `POST /api/whatsapp/disconnect` - Disconnect and clear session
- `POST /api/whatsapp/send` - Send message

**Socket.IO Events (server -> client):**
- `whatsapp:qr` - New QR code available (includes data URL)
- `whatsapp:ready` - Successfully connected
- `whatsapp:disconnected` - Connection lost

### Pattern 3: Frontend QR Display with Real-time Updates
**What:** Settings page listens to Socket.IO, displays QR when received
**When to use:** For the QR code display in browser

**Example:**
```javascript
// Frontend: SettingsPage.jsx
useEffect(() => {
  const socket = io(API_URL);

  socket.on('whatsapp:qr', ({ qrDataUrl }) => {
    setQrCode(qrDataUrl);
    setWhatsappStatus({ needsAuth: true });
  });

  socket.on('whatsapp:ready', () => {
    setQrCode(null);
    setWhatsappStatus({ isReady: true });
  });

  socket.on('whatsapp:disconnected', () => {
    setWhatsappStatus({ isReady: false });
  });

  return () => socket.disconnect();
}, []);
```

### Anti-Patterns to Avoid
- **Polling for QR code:** Don't use HTTP polling when Socket.IO is available - wastes resources and adds latency
- **Multiple WhatsApp client instances:** Always use singleton pattern - multiple instances cause authentication conflicts
- **Storing session in ephemeral storage:** LocalAuth MUST have persistent filesystem - Render Starter provides this

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| QR code rendering | Custom canvas/SVG generation | `qrcode` npm package | Handles all edge cases, generates data URL |
| Session persistence | Manual file management | LocalAuth from whatsapp-web.js | Built-in, handles Chromium profile correctly |
| Real-time browser updates | Long polling or SSE | Socket.IO (already integrated) | Already in use, bidirectional, reconnects |
| Phone number formatting | Regex parsing | Existing code in whatsapp-gateway/index.js | Already handles Israel country code properly |

**Key insight:** The existing gateway code handles phone formatting, message sending, and error handling correctly. Don't rewrite - adapt and integrate.

## Common Pitfalls

### Pitfall 1: Session Not Persisting After Restart
**What goes wrong:** QR code required again after server restart despite LocalAuth
**Why it happens:**
- Missing or incorrect `dataPath` in LocalAuth config
- Ephemeral filesystem (Render Free tier clears storage)
- Wrong clientId between restarts
**How to avoid:**
- Explicitly set `dataPath: './.wwebjs_auth'`
- Use consistent `clientId: 'eden-whatsapp'`
- Deploy to Render Starter ($7/month) for persistent disk
**Warning signs:** QR code appears on every server restart

### Pitfall 2: Puppeteer Chrome Not Found on Render
**What goes wrong:** "Browser was not found at the configured executablePath"
**Why it happens:** Render doesn't include $HOME/.cache in deployment, Puppeteer cache isn't preserved
**How to avoid:** Create `render-build.sh` script:
```bash
#!/usr/bin/env bash
npm install
PUPPETEER_CACHE_DIR=/opt/render/.cache/puppeteer
mkdir -p $PUPPETEER_CACHE_DIR
npx puppeteer browsers install chrome
```
Set build command to `./render-build.sh`
**Warning signs:** Works locally, fails on Render with Chrome not found

### Pitfall 3: Protocol Error Crashes Server
**What goes wrong:** "Protocol error: Session closed" crashes Node.js when user disconnects from mobile app
**Why it happens:** Puppeteer throws unhandled error when WhatsApp session is terminated externally
**How to avoid:**
- Wrap client operations in try-catch
- Add error handler: `client.on('disconnected', ...)`
- Consider adding global unhandled rejection handler as backup
**Warning signs:** Server crashes when user unlinks device from WhatsApp mobile app

### Pitfall 4: Frame Detached Error During Send
**What goes wrong:** "detached Frame" error when sending messages
**Why it happens:** Browser context was destroyed but client still thinks it's connected
**How to avoid:**
- Detect frame detachment in send error handler (already in existing code)
- Reset `isReady = false` and destroy client
- Return 503 to trigger UI to show reconnect prompt
**Warning signs:** First message works, subsequent messages fail

### Pitfall 5: Headless Mode Detection
**What goes wrong:** WhatsApp blocks automated sessions
**Why it happens:** WhatsApp may detect headless Puppeteer as bot
**How to avoid:**
- Some users report `headless: false` with xvfb works better
- Add user-agent flags if needed
- Keep traffic patterns natural (delays between bulk messages)
**Warning signs:** Session works briefly then disconnects, QR scans but never authenticates

### Pitfall 6: Disconnect Button Without Session Cleanup
**What goes wrong:** User clicks disconnect but can't reconnect without server restart
**Why it happens:** Client destroyed but session files remain, causing conflict
**How to avoid:**
- On disconnect, call `client.destroy()`
- Optionally delete `.wwebjs_auth` contents for clean re-auth
- Reset all state flags
**Warning signs:** After disconnect, QR never appears on reconnect attempt

## Code Examples

Verified patterns from official sources and existing codebase:

### Initialize WhatsApp in Server (from existing gateway)
```javascript
// Source: Adapted from whatsapp-gateway/index.js
const { Client, LocalAuth } = require('whatsapp-web.js');

const client = new Client({
  authStrategy: new LocalAuth({
    clientId: 'eden-whatsapp',
    dataPath: './.wwebjs_auth'
  }),
  puppeteer: {
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
  }
});
```

### Generate QR Code as Data URL for Browser
```javascript
// Source: qrcode npm package documentation
const QRCode = require('qrcode');

client.on('qr', async (qr) => {
  // Generate QR as data URL (base64 PNG)
  const qrDataUrl = await QRCode.toDataURL(qr, {
    width: 300,
    margin: 2
  });

  // qrDataUrl is: "data:image/png;base64,..."
  // Can be used directly in <img src={qrDataUrl} />
});
```

### Socket.IO Integration in Server
```javascript
// Source: Existing server/index.js pattern
const io = new Server(server, {
  cors: { origin: "*", methods: ["GET", "POST"] }
});

// Pass io to WhatsApp service
const whatsappService = require('./services/whatsapp');
whatsappService.setIo(io);

// After routes are loaded
whatsappService.initialize();
```

### Frontend Socket.IO Listener (React)
```javascript
// Source: socket.io-client documentation + existing pattern
import { io } from 'socket.io-client';

useEffect(() => {
  const socket = io(API_URL);

  socket.on('whatsapp:qr', ({ qrDataUrl }) => {
    setQrCode(qrDataUrl); // Display directly: <img src={qrCode} />
  });

  socket.on('whatsapp:ready', () => {
    setQrCode(null);
    setSuccessMessage('WhatsApp connected!');
  });

  return () => socket.disconnect();
}, []);
```

### Disconnect Handler with Cleanup
```javascript
// Source: Adapted from whatsapp-gateway/index.js disconnect endpoint
async disconnect() {
  try {
    if (this.client) {
      await this.client.destroy();
      this.client = null;
      this.isReady = false;
      this.qrCode = null;

      if (this.io) {
        this.io.emit('whatsapp:disconnected', { reason: 'manual' });
      }
    }
  } catch (error) {
    console.error('Error during disconnect:', error);
  }
}
```

### Phone Number Formatting (existing code)
```javascript
// Source: whatsapp-gateway/index.js - already handles Israel format
let formattedNumber = phoneNumber.replace(/\D/g, '');

// Add Israel country code if not present
if (!formattedNumber.startsWith('972')) {
  formattedNumber = '972' + formattedNumber.replace(/^0+/, '');
}

const chatId = `${formattedNumber}@c.us`;
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Separate gateway process | Integrated in main server | This phase | Single deployment, simpler architecture |
| HTTP polling for QR | Socket.IO real-time push | This phase | Instant QR updates, better UX |
| External QR API | Local qrcode generation | This phase | Faster, no external dependency |
| Terminal QR display | Browser QR display | Already in Settings page | Manager sees QR without terminal access |

**Deprecated/outdated:**
- `puppeteer: { headless: "new" }` - Can break sessions, use `true` instead
- qrcode-terminal - Only for terminal, not browser

## Open Questions

Things that couldn't be fully resolved:

1. **Session Stability Over Days**
   - What we know: Some users report sessions disconnect after 2-3 days
   - What's unclear: Whether this is WhatsApp policy or implementation issue
   - Recommendation: Implement graceful reconnection, monitor in production

2. **Render Starter Disk Persistence**
   - What we know: Starter tier has persistent disk, Free tier is ephemeral
   - What's unclear: Exact behavior during deploys/restarts
   - Recommendation: Test session persistence after deploy before going live

3. **iPhone vs Android Linking**
   - What we know: Some report iPhone sessions less stable
   - What's unclear: Whether this affects production usage
   - Recommendation: Test with manager's actual device, document any quirks

## Sources

### Primary (HIGH confidence)
- [wwebjs.dev Authentication Guide](https://wwebjs.dev/guide/creating-your-bot/authentication) - LocalAuth configuration, dataPath, clientId
- Existing code: `whatsapp-gateway/index.js` - Working implementation to adapt
- Existing code: `server/services/whatsapp.js` - Current HTTP gateway client pattern
- Existing code: `client/src/pages/SettingsPage.jsx` - Current QR display UI

### Secondary (MEDIUM confidence)
- [Render Puppeteer Deploy Guide](https://render.com/docs/deploy-puppeteer-node) - Puppeteer on Render
- [Dev.to: Deploy Puppeteer on Render](https://dev.to/umer009/how-to-deploy-puppeteer-with-node-on-rendercom-4jo7) - render-build.sh script
- [GitHub: wwebjs-express-socketio-boilerplate](https://github.com/feri-irawan/wwebjs-express-socketio-boilerplate) - Integration pattern

### Tertiary (LOW confidence - needs validation)
- [GitHub Issues: Session persistence problems](https://github.com/pedroslopez/whatsapp-web.js/issues/2164) - LocalAuth may require monitoring
- [GitHub Issues: Protocol errors](https://github.com/pedroslopez/whatsapp-web.js/issues/3904) - Crash handling needed

## Render Deployment Checklist

For successful deployment on Render Starter:

1. **render-build.sh script:**
```bash
#!/usr/bin/env bash
set -o errexit
npm install
PUPPETEER_CACHE_DIR=/opt/render/.cache/puppeteer
mkdir -p $PUPPETEER_CACHE_DIR
npx puppeteer browsers install chrome
```

2. **Build command:** `./render-build.sh`
3. **Start command:** `npm start`
4. **Plan:** Starter ($7/month) - required for persistent disk and always-on
5. **Environment:** Verify NODE_ENV=production

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - Using existing libraries already in package.json
- Architecture: HIGH - Clear pattern from existing code and Socket.IO integration
- Pitfalls: MEDIUM - Based on GitHub issues, needs production validation

**Research date:** 2026-01-26
**Valid until:** 60 days (stable library, no major changes expected)
