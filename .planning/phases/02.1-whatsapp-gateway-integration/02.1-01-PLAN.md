---
phase: 02.1-whatsapp-gateway-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - server/services/whatsapp.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "WhatsApp client runs inside main server process"
    - "QR code is emitted via Socket.IO when generated"
    - "Ready/disconnected events are emitted via Socket.IO"
    - "Session persists via LocalAuth to .wwebjs_auth directory"
  artifacts:
    - path: "server/services/whatsapp.js"
      provides: "WhatsApp singleton with Socket.IO integration"
      exports: ["whatsappService"]
      min_lines: 100
    - path: "server/index.js"
      provides: "io wiring to WhatsApp service"
      contains: "whatsappService.setIo"
  key_links:
    - from: "server/services/whatsapp.js"
      to: "socket.io"
      via: "io.emit('whatsapp:qr'), io.emit('whatsapp:ready')"
      pattern: "io\\.emit\\('whatsapp:"
    - from: "server/index.js"
      to: "server/services/whatsapp.js"
      via: "whatsappService.setIo(io)"
      pattern: "setIo\\(io\\)"
---

<objective>
Create the core WhatsApp service integrated into the main server with Socket.IO for real-time QR delivery.

Purpose: Move WhatsApp client from separate gateway process into main server, enabling persistent connection and real-time browser updates.

Output: WhatsApp singleton service with Socket.IO events, wired to main server.
</objective>

<execution_context>
@C:\Users\sarha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\sarha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-RESEARCH.md

# Existing code to adapt
@whatsapp-gateway/index.js
@server/services/whatsapp.js
@server/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode and create WhatsApp service</name>
  <files>package.json, server/services/whatsapp.js</files>
  <action>
1. Install qrcode npm package:
   ```bash
   npm install qrcode
   ```

2. REWRITE server/services/whatsapp.js as a singleton class with:
   - Constructor: Initialize state (client=null, isReady=false, qrCode=null, io=null)
   - setIo(io): Store Socket.IO instance for emitting events
   - async initialize(): Create Client with LocalAuth, set up event handlers

   Client configuration (from existing gateway code):
   ```javascript
   new Client({
     authStrategy: new LocalAuth({
       clientId: 'eden-whatsapp',
       dataPath: './.wwebjs_auth'
     }),
     puppeteer: {
       headless: true,
       args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu']
     }
   })
   ```

   Event handlers:
   - 'qr': Generate QR as data URL using qrcode.toDataURL(), emit via io.emit('whatsapp:qr', { qrDataUrl })
   - 'ready': Set isReady=true, qrCode=null, emit io.emit('whatsapp:ready')
   - 'authenticated': Log success
   - 'disconnected': Set isReady=false, client=null, emit io.emit('whatsapp:disconnected', { reason })

   Additional methods (adapt from existing gateway/index.js):
   - getStatus(): Return { isReady, needsAuth: qrCode !== null, isInitialized: client !== null }
   - async sendMessage(phoneNumber, message): Format Israel phone (972), send via client.sendMessage()
   - async sendBulkMessages(messages): Iterate with 1000ms delay between messages
   - async disconnect(): Destroy client, reset state, emit disconnected event

   Error handling:
   - Detect "detached Frame" errors in sendMessage/sendBulkMessages
   - On frame detachment: set isReady=false, destroy client, emit disconnected

   Export singleton instance: module.exports = new WhatsAppService()
  </action>
  <verify>
    - File server/services/whatsapp.js exists with WhatsAppService class
    - npm ls qrcode shows package installed
    - Class has methods: setIo, initialize, getStatus, sendMessage, sendBulkMessages, disconnect
  </verify>
  <done>
    WhatsApp service module created with Socket.IO integration, LocalAuth persistence, and all methods from existing gateway
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WhatsApp service to server with Socket.IO</name>
  <files>server/index.js</files>
  <action>
1. In server/index.js, after Socket.IO setup and before routes:
   ```javascript
   // Initialize WhatsApp service with Socket.IO
   const whatsappService = require('./services/whatsapp');
   whatsappService.setIo(io);
   ```

2. After routes are loaded, initialize WhatsApp:
   ```javascript
   // Initialize WhatsApp client (auto-reconnects if session exists)
   whatsappService.initialize().catch(err => {
     console.error('WhatsApp initialization error:', err);
   });
   ```

3. Remove or update the comment about "WhatsApp uses a local gateway" - replace with:
   ```javascript
   // WhatsApp client is integrated directly - no separate gateway needed
   ```

4. Keep the existing Socket.IO connection logging.

5. Ensure the io instance export remains at bottom for other modules.

IMPORTANT: Do NOT remove any existing route registrations or middleware.
  </action>
  <verify>
    - server/index.js imports whatsappService
    - whatsappService.setIo(io) is called
    - whatsappService.initialize() is called after routes
    - Server still starts without errors: cd server && node index.js (check startup logs)
  </verify>
  <done>
    Main server initializes WhatsApp service with Socket.IO, ready to emit QR events
  </done>
</task>

</tasks>

<verification>
1. Server starts without errors
2. WhatsApp service logs "Initializing WhatsApp client..."
3. QR code appears in server console (qrcode-terminal still works for debugging)
4. Socket.IO events are ready to be received by frontend
</verification>

<success_criteria>
- [ ] qrcode package installed in package.json
- [ ] server/services/whatsapp.js is a singleton with Socket.IO integration
- [ ] server/index.js passes io to whatsapp service
- [ ] Server starts and WhatsApp client initializes
- [ ] LocalAuth configured with dataPath './.wwebjs_auth'
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-whatsapp-gateway-integration/02.1-01-SUMMARY.md`
</output>
