---
phase: 02.1-whatsapp-gateway-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - whatsapp-gateway/index.js
  - server/services/whatsapp.js
  - client/src/pages/SettingsPage.jsx
autonomous: false

must_haves:
  truths:
    - "Manager sees clear Hebrew error when gateway is not running"
    - "Manager sees clear Hebrew error when WhatsApp is not authenticated"
    - "Frame detachment errors properly destroy client and require reconnect"
    - "Success messages only appear when messages are actually sent"
    - "Manager can check WhatsApp connection status from UI"
  artifacts:
    - path: "whatsapp-gateway/index.js"
      provides: "Frame detachment detection with client reset"
      contains: "detached Frame"
      min_lines: 180
    - path: "server/services/whatsapp.js"
      provides: "Error categorization with Hebrew messages"
      exports: ["getStatus", "sendMessage", "sendBulkMessages"]
      min_lines: 150
    - path: "client/src/pages/SettingsPage.jsx"
      provides: "WhatsApp status indicator UI"
      contains: "whatsapp"
      min_lines: 100
  key_links:
    - from: "server/services/whatsapp.js"
      to: "whatsapp-gateway/index.js"
      via: "HTTP status and send endpoints"
      pattern: "axios.*gateway"
    - from: "client/src/pages/SettingsPage.jsx"
      to: "server/services/whatsapp.js"
      via: "Status check API"
      pattern: "fetch.*whatsapp.*status"
---

<objective>
Make WhatsApp gateway failures visible and actionable for managers

Purpose: Transform existing working gateway from "partially functional" to "production reliable" by ensuring all failure modes (gateway down, not authenticated, frame detached) show clear Hebrew error messages instead of misleading success indicators.

Output: Manager receives clear, actionable Hebrew error messages for all WhatsApp failure scenarios, with visible status indicator in settings showing connection state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-RESEARCH.md
@whatsapp-gateway/index.js
@server/services/whatsapp.js
@.planning/debug/resolved/whatsapp-delivery-failure.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance frame detachment error handling in gateway</name>
  <files>whatsapp-gateway/index.js</files>
  <action>
  Add comprehensive error detection and recovery in the /send and /send-bulk endpoints.

  For every client.sendMessage() call:
  1. Wrap in try/catch
  2. Check if error.message includes "detached Frame"
  3. If frame detached:
     - Log clear error: "Frame detached - client is broken, resetting state"
     - Set isReady = false
     - Destroy client: await client.destroy()
     - Set client = null
     - Return 503 status with error: "חיבור WhatsApp התנתק. יש להתחבר מחדש דרך ההגדרות"
  4. For other errors, return 500 with original error.message

  This ensures frame detachment is caught early and manager gets clear reconnection instruction.

  Pattern already exists in resolved debug session (whatsapp-delivery-failure.md) - verify it's properly implemented in both /send and /send-bulk endpoints.
  </action>
  <verify>
  1. Read whatsapp-gateway/index.js and confirm:
     - /send endpoint has try/catch around client.sendMessage
     - Error handler checks for "detached Frame" string
     - Frame detachment sets isReady=false and destroys client
     - Hebrew error message returned: "חיבור WhatsApp התנתק"
  2. Same checks for /send-bulk endpoint
  3. Run: cd whatsapp-gateway && npm start
  4. Verify gateway starts and shows initialization logs
  </verify>
  <done>
  Both /send and /send-bulk endpoints properly detect frame detachment errors, reset client state, and return Hebrew error message requiring reconnection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Improve error categorization in gateway client service</name>
  <files>server/services/whatsapp.js</files>
  <action>
  Enhance sendMessage() and sendBulkMessages() error handling to provide specific Hebrew messages for each failure mode.

  In sendMessage() catch block, categorize errors:
  1. ECONNREFUSED → "שרת WhatsApp המקומי אינו זמין - וודא שהשרת רץ על המחשב שלך"
  2. response.status === 400 → "וואטסאפ אינו מחובר. אנא התחבר תחילה דרך ההגדרות"
  3. response.status === 503 → Pass through error.response.data.error (contains reconnect instruction)
  4. Other errors → "שגיאה בשליחת הודעה: " + (error.response?.data?.error || error.message)

  Add timeout handling:
  - If timeout error (ETIMEDOUT, ECONNABORTED), show: "שרת WhatsApp לא מגיב - בדוק שהשרת רץ ותנסה שוב"

  For sendBulkMessages(), wrap in same error handling and re-throw with categorized message so bulk send routes can show specific errors.

  Verify getStatus() already handles ECONNREFUSED gracefully and returns clear error message.
  </action>
  <verify>
  1. Read server/services/whatsapp.js
  2. Confirm sendMessage() has 5 error cases with Hebrew messages
  3. Confirm sendBulkMessages() wraps errors properly
  4. Confirm getStatus() handles gateway unreachable
  5. Run: npm test (if tests exist) or manually inspect code
  </verify>
  <done>
  All WhatsApp gateway errors are categorized and translated to clear Hebrew messages indicating exactly what went wrong and what action manager should take.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add WhatsApp status indicator to Settings UI</name>
  <files>client/src/pages/SettingsPage.jsx</files>
  <action>
  Add visual WhatsApp connection status to Settings page.

  1. Import useState, useEffect from React
  2. Add state: const [whatsappStatus, setWhatsappStatus] = useState(null)
  3. Add useEffect to fetch status on mount:
     ```javascript
     useEffect(() => {
       const checkStatus = async () => {
         try {
           const response = await fetch('/api/whatsapp/status');
           const data = await response.json();
           setWhatsappStatus(data);
         } catch (error) {
           setWhatsappStatus({ isReady: false, error: 'לא ניתן להתחבר לשרת' });
         }
       };
       checkStatus();
       const interval = setInterval(checkStatus, 10000); // Poll every 10s
       return () => clearInterval(interval);
     }, []);
     ```
  4. Add status indicator UI in Settings section (below existing settings):
     - If whatsappStatus.isReady === true:
       - Green dot (bg-green-500) + "WhatsApp מחובר ומוכן"
     - Else if whatsappStatus.needsAuth === true:
       - Yellow dot (bg-yellow-500) + "WhatsApp ממתין לאימות - סרוק QR"
     - Else if whatsappStatus.error:
       - Red dot (bg-red-500) + whatsappStatus.error
     - Else:
       - Gray dot (bg-gray-400) + "סטטוס לא ידוע"

  Use existing Settings page styling patterns (RTL, Tailwind, card layout).
  </action>
  <verify>
  1. Read client/src/pages/SettingsPage.jsx
  2. Confirm useState and useEffect hooks added
  3. Confirm status fetch logic with 10s polling
  4. Confirm 4 status states rendered (green/yellow/red/gray)
  5. Run: npm run dev (from client dir) and visit Settings page
  6. Verify status indicator appears and updates
  </verify>
  <done>
  Settings page displays real-time WhatsApp connection status with color-coded indicator (green=ready, yellow=needs auth, red=error, gray=unknown) and Hebrew status text, polling every 10 seconds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Enhanced WhatsApp gateway error handling with Hebrew messages and UI status indicator
  </what-built>
  <how-to-verify>
  Test all three error scenarios:

  **Scenario 1: Gateway not running**
  1. Ensure whatsapp-gateway is stopped (close terminal if running)
  2. Open Eden app in browser
  3. Go to Settings page
  4. Expected: Red dot + "שרת WhatsApp המקומי אינו זמין - וודא שהשרת רץ על המחשב שלך"
  5. Try to send a task
  6. Expected: Error toast with same Hebrew message

  **Scenario 2: Gateway running but not authenticated**
  1. Start gateway: cd whatsapp-gateway && npm start
  2. DO NOT scan QR code
  3. Settings page should show: Yellow dot + "WhatsApp ממתין לאימות - סרוק QR"
  4. Try to send a task
  5. Expected: Error toast with "וואטסאפ אינו מחובר. אנא התחבר תחילה דרך ההגדרות"

  **Scenario 3: Fully connected and working**
  1. Scan QR code in gateway terminal
  2. Wait for "WhatsApp client is ready!"
  3. Settings page should show: Green dot + "WhatsApp מחובר ומוכן"
  4. Send a test task to your phone number
  5. Expected: Success message AND message arrives on WhatsApp

  All three scenarios must show correct status and error messages.
  </how-to-verify>
  <resume-signal>
  Type "approved" if all scenarios work correctly, or describe which scenario failed
  </resume-signal>
</task>

</tasks>

<verification>
1. Gateway detects and recovers from frame detachment errors
2. All error types show specific Hebrew messages
3. Settings page displays real-time connection status
4. Manager can diagnose WhatsApp issues without checking server logs
5. No false success messages when sends actually fail
</verification>

<success_criteria>
- [ ] Frame detachment errors reset client state and show reconnect instruction
- [ ] ECONNREFUSED errors show "gateway not running" message in Hebrew
- [ ] 400 errors show "not authenticated" message in Hebrew
- [ ] Settings page shows green/yellow/red status indicator
- [ ] Status indicator updates every 10 seconds
- [ ] All three error scenarios verified by manager
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-whatsapp-gateway-integration/02.1-01-SUMMARY.md`
</output>
