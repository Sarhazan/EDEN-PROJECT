---
phase: 02.1-whatsapp-gateway-integration
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - server/routes/whatsapp.js
  - client/src/pages/SettingsPage.jsx
autonomous: true

must_haves:
  truths:
    - "Manager sees QR code in browser when connecting"
    - "QR updates in real-time via Socket.IO (no page refresh)"
    - "Manager sees success message when WhatsApp connects"
    - "Manager can click disconnect button to disconnect WhatsApp"
    - "Status indicator shows current connection state"
  artifacts:
    - path: "server/routes/whatsapp.js"
      provides: "HTTP endpoints using integrated WhatsApp service"
      exports: ["router"]
    - path: "client/src/pages/SettingsPage.jsx"
      provides: "Settings UI with Socket.IO and disconnect button"
      contains: "socket.on('whatsapp:qr'"
  key_links:
    - from: "client/src/pages/SettingsPage.jsx"
      to: "socket.io-client"
      via: "socket.on('whatsapp:qr', 'whatsapp:ready', 'whatsapp:disconnected')"
      pattern: "socket\\.on\\('whatsapp:"
    - from: "client/src/pages/SettingsPage.jsx"
      to: "/api/whatsapp/disconnect"
      via: "axios.post on button click"
      pattern: "handleDisconnect"
---

<objective>
Update API routes to work with integrated WhatsApp service and add Socket.IO listeners + disconnect button to Settings page.

Purpose: Complete the frontend integration so manager sees QR in browser and can control WhatsApp connection.

Output: Working Settings page with real-time QR display and disconnect functionality.
</objective>

<execution_context>
@C:\Users\sarha\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\sarha\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-RESEARCH.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-01-SUMMARY.md

# Files to modify
@server/routes/whatsapp.js
@client/src/pages/SettingsPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WhatsApp routes to use integrated service</name>
  <files>server/routes/whatsapp.js</files>
  <action>
The routes file currently calls whatsappService methods that expect HTTP gateway responses. Update it to work with the new integrated service:

1. The service methods now return direct values, not axios responses. Update accordingly:
   - getStatus() returns object directly (no .data needed)
   - sendMessage() returns { success: true } or throws
   - sendBulkMessages() returns results array or throws

2. Update GET /status:
   - Call whatsappService.getStatus() directly
   - Return the result as JSON (already correct structure)

3. Update POST /connect:
   - The new service doesn't have a getQRCode() method - it emits QR via Socket.IO
   - Change this endpoint to trigger initialization if not already initialized
   - If already connected (isReady), return success
   - If not initialized, call whatsappService.initialize() and return { initializing: true }
   - The QR will arrive via Socket.IO, not HTTP response

   New logic:
   ```javascript
   router.post('/connect', async (req, res) => {
     try {
       const status = whatsappService.getStatus();

       if (status.isReady) {
         return res.json({ success: true, message: 'Already connected', isReady: true });
       }

       if (!status.isInitialized) {
         // Start initialization - QR will come via Socket.IO
         whatsappService.initialize().catch(err => {
           console.error('WhatsApp initialization error:', err);
         });
       }

       // Return immediately - frontend should listen for Socket.IO events
       res.json({ success: true, message: 'Initializing - watch for QR via Socket.IO', initializing: true });
     } catch (error) {
       res.status(500).json({ error: error.message });
     }
   });
   ```

4. Update POST /disconnect:
   - Call whatsappService.disconnect()
   - Return success message

5. Update POST /send:
   - Call whatsappService.sendMessage(phoneNumber, message)
   - Handle success/error directly

6. Update POST /send-bulk:
   - Use whatsappService.getStatus() (not await, it's synchronous now)
   - sendMessage is still the method to call per employee
   - Keep the existing task confirmation logic (token generation, HTML generation, etc.)

7. Remove axios import - no longer needed for gateway communication.

8. Keep all existing helper functions (waitForUrlAvailable) and business logic intact.
  </action>
  <verify>
    - No axios import for gateway communication
    - GET /status works (returns status object)
    - POST /connect returns initializing message
    - POST /disconnect calls service disconnect
    - POST /send and /send-bulk still function
    - Server starts without route errors
  </verify>
  <done>
    WhatsApp routes updated to use integrated service API instead of HTTP gateway calls
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Socket.IO listeners and disconnect button to Settings page</name>
  <files>client/src/pages/SettingsPage.jsx</files>
  <action>
1. Add socket.io-client import at top:
   ```javascript
   import { io } from 'socket.io-client';
   ```

2. Add state for socket connection:
   ```javascript
   const [socket, setSocket] = useState(null);
   ```

3. Add useEffect for Socket.IO connection (run once on mount):
   ```javascript
   useEffect(() => {
     const newSocket = io(API_URL);
     setSocket(newSocket);

     newSocket.on('whatsapp:qr', ({ qrDataUrl }) => {
       console.log('Received QR code via Socket.IO');
       setQrCode(qrDataUrl);  // qrDataUrl is already a data URL, use directly in img src
       setWhatsappStatus(prev => ({ ...prev, needsAuth: true, isReady: false }));
       setSuccessMessage('Scan the QR code with your phone');
     });

     newSocket.on('whatsapp:ready', () => {
       console.log('WhatsApp ready via Socket.IO');
       setQrCode(null);
       setWhatsappStatus({ isReady: true, needsAuth: false, isInitialized: true });
       setSuccessMessage('Connected to WhatsApp successfully!');
     });

     newSocket.on('whatsapp:disconnected', ({ reason }) => {
       console.log('WhatsApp disconnected:', reason);
       setQrCode(null);
       setWhatsappStatus({ isReady: false, needsAuth: false, isInitialized: false });
       if (reason !== 'manual') {
         setError('WhatsApp disconnected: ' + reason);
       }
     });

     return () => {
       newSocket.disconnect();
     };
   }, []);
   ```

4. Update handleConnect:
   - Remove the polling logic (startPolling) - Socket.IO handles this now
   - Just call /connect endpoint and show appropriate message
   ```javascript
   const handleConnect = async () => {
     setLoading(true);
     setError(null);
     setSuccessMessage(null);

     try {
       const response = await axios.post(`${API_URL}/whatsapp/connect`);

       if (response.data.isReady) {
         setSuccessMessage('Already connected to WhatsApp!');
         setWhatsappStatus({ isReady: true, needsAuth: false, isInitialized: true });
       } else if (response.data.initializing) {
         setSuccessMessage('Initializing... QR code will appear shortly');
       }
     } catch (error) {
       setError(error.response?.data?.error || 'Error connecting to WhatsApp');
     } finally {
       setLoading(false);
     }
   };
   ```

5. Add handleDisconnect function:
   ```javascript
   const handleDisconnect = async () => {
     setLoading(true);
     setError(null);

     try {
       await axios.post(`${API_URL}/whatsapp/disconnect`);
       setSuccessMessage('Disconnected from WhatsApp');
       setWhatsappStatus({ isReady: false, needsAuth: false, isInitialized: false });
       setQrCode(null);
     } catch (error) {
       setError(error.response?.data?.error || 'Error disconnecting');
     } finally {
       setLoading(false);
     }
   };
   ```

6. Update QR code display - use qrDataUrl directly (no external API):
   Change from:
   ```jsx
   <img src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrCode)}`} />
   ```
   To:
   ```jsx
   <img src={qrCode} alt="WhatsApp QR Code" className="w-64 h-64 border-4 border-gray-300 rounded-lg" />
   ```

7. Add disconnect button in Action Buttons section (show only when connected):
   ```jsx
   {whatsappStatus.isReady && (
     <button
       onClick={handleDisconnect}
       disabled={loading}
       className="flex-1 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
     >
       <FaTimes />
       {loading ? 'Disconnecting...' : 'Disconnect from WhatsApp'}
     </button>
   )}
   ```

8. Remove the startPolling function - no longer needed.

9. Update the info box to reflect new behavior:
   - "QR scan required once"
   - "Session persists across server restarts"
   - "Click Disconnect to manually disconnect"

10. Keep Hebrew translations for user-facing text.
  </action>
  <verify>
    - Socket.IO import added
    - useEffect sets up socket listeners for whatsapp:qr, whatsapp:ready, whatsapp:disconnected
    - QR code displays using data URL directly (not external API)
    - Disconnect button appears when connected
    - handleDisconnect function calls /disconnect endpoint
    - No startPolling function remains
  </verify>
  <done>
    Settings page has real-time QR display via Socket.IO and disconnect button for manual disconnection
  </done>
</task>

</tasks>

<verification>
1. Start server and open Settings page
2. Click "Connect to WhatsApp" - QR code appears in browser (not terminal only)
3. Scan QR with phone - status updates to "Connected" automatically
4. Disconnect button appears when connected
5. Click disconnect - status changes to disconnected
6. Task notifications still send successfully (test /send endpoint)
</verification>

<success_criteria>
- [ ] Routes use integrated service (no axios gateway calls)
- [ ] Settings page connects to Socket.IO on mount
- [ ] QR code displayed as data URL (local generation)
- [ ] Status updates in real-time via Socket.IO events
- [ ] Disconnect button visible when connected
- [ ] Disconnect button calls /api/whatsapp/disconnect
- [ ] Success/error messages display correctly in Hebrew
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-whatsapp-gateway-integration/02.1-02-SUMMARY.md`
</output>
