---
phase: 02.1-whatsapp-gateway-integration
plan: 02
type: execute
wave: 2
depends_on: [02.1-01]
files_modified:
  - whatsapp-gateway/package.json
  - WHATSAPP_SETUP.md
  - package.json
autonomous: false

user_setup:
  - service: whatsapp-gateway
    why: "Local gateway must run on manager's machine for WhatsApp connection"
    env_vars:
      - name: WHATSAPP_GATEWAY_URL
        source: "Use local network IP (e.g., http://192.168.1.35:3003) or localhost"
        location: "Render Dashboard → eden-project → Environment → Add Variable"
    dashboard_config: []
    manual_steps:
      - task: "Start gateway on local machine"
        command: "cd whatsapp-gateway && npm start"
        when: "Before sending WhatsApp messages"
      - task: "Scan QR code with WhatsApp"
        details: "Open WhatsApp on phone → Settings → Linked Devices → Link a Device → Scan QR in terminal"
        when: "First time only (session persists)"

must_haves:
  truths:
    - "Manager can start gateway with single npm command"
    - "Manager sees clear QR code in terminal for scanning"
    - "WhatsApp session persists across gateway restarts"
    - "Messages are successfully delivered to employee phones"
    - "Manager knows how to diagnose and fix common issues"
  artifacts:
    - path: "whatsapp-gateway/package.json"
      provides: "Start script for easy gateway launch"
      contains: "\"start\""
    - path: "WHATSAPP_SETUP.md"
      provides: "Step-by-step manager instructions in Hebrew"
      min_lines: 100
    - path: "package.json"
      provides: "Root-level script to start gateway from any directory"
      contains: "\"gateway\""
  key_links:
    - from: "Manager machine"
      to: "whatsapp-gateway:3003"
      via: "Local process (npm start)"
      pattern: "port 3003"
    - from: "Render server"
      to: "Manager machine"
      via: "WHATSAPP_GATEWAY_URL env var"
      pattern: "192.168.1.35:3003"
    - from: "whatsapp-gateway"
      to: "WhatsApp Web"
      via: "Puppeteer LocalAuth session"
      pattern: ".wwebjs_auth"

---

<objective>
Validate end-to-end WhatsApp integration and provide clear manager documentation

Purpose: Ensure the WhatsApp gateway works reliably from manager's perspective - easy to start, authenticate once, and send messages. Document all workflows so manager can operate independently without technical support.

Output: Manager can successfully start gateway, connect WhatsApp, send messages to employees, and troubleshoot common issues using clear Hebrew instructions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-RESEARCH.md
@.planning/phases/02.1-whatsapp-gateway-integration/02.1-01-SUMMARY.md
@WHATSAPP_SETUP.md
@whatsapp-gateway/package.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add convenience scripts for gateway management</name>
  <files>whatsapp-gateway/package.json, package.json</files>
  <action>
  Make gateway startup easier with npm scripts.

  **In whatsapp-gateway/package.json:**
  1. Verify "start" script exists: "node index.js"
  2. If missing, add it to scripts section

  **In root package.json (main project root):**
  1. Add "gateway" script: "cd whatsapp-gateway && npm start"
  2. This allows manager to run `npm run gateway` from any directory

  Keep scripts simple - no complex tooling, just direct execution.
  </action>
  <verify>
  1. Read whatsapp-gateway/package.json
  2. Confirm "start" script exists and points to index.js
  3. Read root package.json
  4. Confirm "gateway" script exists and changes directory before starting
  5. Test: npm run gateway (should start gateway from root directory)
  </verify>
  <done>
  Gateway can be started with `npm start` (from whatsapp-gateway directory) or `npm run gateway` (from project root), providing flexible startup options for manager.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and validate setup documentation</name>
  <files>WHATSAPP_SETUP.md</files>
  <action>
  Update WHATSAPP_SETUP.md to reflect current implementation and error handling improvements.

  Ensure documentation covers:

  **התקנה (Installation) - One time:**
  1. cd whatsapp-gateway
  2. npm install
  3. npm start
  4. Scan QR code in terminal with WhatsApp phone
  5. Wait for "WhatsApp client is ready!"

  **שימוש יומיומי (Daily use):**
  1. Start gateway: npm run gateway (or npm start from whatsapp-gateway/)
  2. Open Eden app in browser
  3. Check Settings page - should show green status
  4. Send tasks normally - messages go automatically

  **פתרון בעיות (Troubleshooting):**
  1. "שרת WhatsApp המקומי אינו זמין" → Start gateway with npm run gateway
  2. "וואטסאפ אינו מחובר" → Check Settings page for yellow status, re-scan QR if needed
  3. "חיבור WhatsApp התנתק" → Restart gateway (Ctrl+C then npm start), usually reconnects automatically without QR
  4. QR expired before scanning → Restart gateway to get fresh QR

  **טיפים (Tips):**
  - Session persists in .wwebjs_auth/ directory - only scan QR once
  - Gateway must run while sending messages, can stop between uses
  - Check Settings page green indicator before bulk sends
  - Visible browser window (headless: false) helps diagnose issues

  Keep language in Hebrew, friendly tone, step-by-step format. Target audience: non-technical manager who knows how to run npm commands.
  </action>
  <verify>
  1. Read WHATSAPP_SETUP.md
  2. Confirm all 4 sections present: התקנה, שימוש יומיומי, פתרון בעיות, טיפים
  3. Confirm troubleshooting covers all error messages from Plan 01
  4. Confirm instructions are in Hebrew
  5. Verify format is clear and step-by-step
  </verify>
  <done>
  WHATSAPP_SETUP.md contains complete Hebrew instructions covering installation, daily use, troubleshooting (with specific error message solutions), and tips for reliable operation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete end-to-end WhatsApp gateway integration with manager documentation
  </what-built>
  <how-to-verify>
  **Full workflow test (simulating manager's experience):**

  **Step 1: Fresh start**
  1. Close any running gateway instances
  2. From project root, run: npm run gateway
  3. Expected: Gateway starts, shows "Eden WhatsApp Gateway" banner
  4. Expected: QR code appears in terminal within 30 seconds

  **Step 2: Authentication**
  1. Open WhatsApp on your phone
  2. Go to Settings → Linked Devices → Link a Device
  3. Scan the QR code from terminal
  4. Expected: Terminal shows "WhatsApp authenticated successfully" then "WhatsApp client is ready!"
  5. Open Eden app → Settings page
  6. Expected: Green dot + "WhatsApp מחובר ומוכן"

  **Step 3: Send test messages**
  1. In Eden app, go to "היום שלי" (My Day)
  2. Create a new task for an employee with your phone number
  3. Click "שלח משימה" (Send Task)
  4. Expected: Success message in UI
  5. Expected: WhatsApp message arrives on your phone within 5 seconds
  6. Verify message contains task details in correct format

  **Step 4: Session persistence**
  1. In gateway terminal, press Ctrl+C to stop
  2. Restart gateway: npm run gateway
  3. Expected: NO QR code shown (session already exists)
  4. Expected: Gateway goes straight to "WhatsApp client is ready!"
  5. Send another test task
  6. Expected: Message arrives successfully without re-scanning

  **Step 5: Error handling**
  1. Stop gateway (Ctrl+C)
  2. Try to send a task from Eden app
  3. Expected: Error message "שרת WhatsApp המקומי אינו זמין"
  4. Settings page should show red status
  5. Follow troubleshooting steps from WHATSAPP_SETUP.md
  6. Verify instructions are clear and fix the issue

  **Step 6: Documentation validation**
  1. Read WHATSAPP_SETUP.md as if you're a non-technical manager
  2. Verify all steps are clear and in Hebrew
  3. Check that each error message from testing is documented with solution
  4. Confirm tips section covers session persistence and browser window

  All steps must work smoothly. Document any confusion or missing steps.
  </how-to-verify>
  <resume-signal>
  Type "approved" with confirmation that all 6 steps worked, or describe which step failed and how
  </resume-signal>
</task>

</tasks>

<verification>
1. Gateway starts with single command from any directory
2. QR authentication works and persists across restarts
3. Messages are delivered successfully to WhatsApp
4. Manager documentation covers all scenarios in Hebrew
5. Troubleshooting guide addresses all error messages
6. End-to-end workflow validated from manager perspective
</verification>

<success_criteria>
- [ ] npm run gateway starts gateway from project root
- [ ] QR code appears in terminal within 30 seconds
- [ ] WhatsApp authentication persists in .wwebjs_auth/
- [ ] Test messages delivered successfully to employee phones
- [ ] Gateway reconnects without QR after restart
- [ ] WHATSAPP_SETUP.md covers all error scenarios
- [ ] Documentation is clear for non-technical manager
- [ ] Full workflow tested and verified working
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-whatsapp-gateway-integration/02.1-02-SUMMARY.md`
</output>
