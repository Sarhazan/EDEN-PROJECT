---
phase: 05-multi-language-support
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/database/schema.js
  - server/routes/employees.js
  - client/src/components/EmployeeForm.jsx
  - client/src/components/EmployeesPage.jsx
autonomous: true

must_haves:
  truths:
    - "Employee language preference is persisted and validated (only he/en/ru/ar allowed)"
    - "Manager can select employee language in UI (he, en, ru, ar)"
    - "Employee language preference saved to database"
    - "Default language is Hebrew (he) for existing employees"
  artifacts:
    - path: "server/database/schema.js"
      provides: "employees.language column migration"
      contains: "ALTER TABLE employees ADD COLUMN language"
    - path: "server/routes/employees.js"
      provides: "Language field in employee CRUD endpoints"
      contains: "language"
    - path: "client/src/components/EmployeeForm.jsx"
      provides: "Language dropdown selector"
      contains: "select.*language"
  key_links:
    - from: "client/src/components/EmployeeForm.jsx"
      to: "POST /api/employees"
      via: "Form submission with language field"
      pattern: "fetch.*employees.*language"
    - from: "server/routes/employees.js"
      to: "employees.language column"
      via: "SQL INSERT/UPDATE with language"
      pattern: "INSERT.*employees.*language"
---

<objective>
Add language preference field to employees table and manager UI for selecting employee language.

Purpose: Enable managers to configure each employee's preferred language (Hebrew, English, Russian, or Arabic), which will be used for WhatsApp messages and interactive task pages. This is the foundation for per-employee multilingual communication.

Output: Database schema updated with language column, API endpoints support language field, manager UI has language selector dropdown in employee form.
</objective>

<execution_context>
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\workflows\execute-plan.md
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@c:\dev\projects\claude projects\eden claude\.planning\PROJECT.md
@c:\dev\projects\claude projects\eden claude\.planning\ROADMAP.md
@c:\dev\projects\claude projects\eden claude\.planning\STATE.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-RESEARCH.md

# Current implementation
@c:\dev\projects\claude projects\eden claude\server\database\schema.js
@c:\dev\projects\claude projects\eden claude\server\routes\employees.js
@c:\dev\projects\claude projects\eden claude\client\src\components\EmployeeForm.jsx
</context>

<tasks>

<task type="auto">
  <name>Add language column to employees table</name>
  <files>server/database/schema.js</files>
  <action>
Add language column migration to employees table schema.

In `server/database/schema.js`, add migration after other `ALTER TABLE employees` migrations:

```javascript
// Add language column if it doesn't exist (migration for Phase 5)
try {
  db.exec(`ALTER TABLE employees ADD COLUMN language TEXT DEFAULT 'he' CHECK(language IN ('he', 'en', 'ru', 'ar'))`);
  console.log('Added language column to employees table');
} catch (e) {
  // Column already exists, ignore error
  if (!e.message.includes('duplicate column name')) {
    console.error('Error adding language column:', e.message);
  }
}
```

Language codes (ISO 639-1):
- 'he': Hebrew (×¢×‘×¨×™×ª) - default
- 'en': English
- 'ru': Russian (Ğ ÑƒÑÑĞºĞ¸Ğ¹)
- 'ar': Arabic (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)

CHECK constraint ensures only valid language codes can be stored.
DEFAULT 'he' ensures existing employees and new employees without specified language default to Hebrew.

Place this migration in the `initializeDatabase()` function after the acknowledged_at, completion_note, estimated_duration_minutes, and completed_at migrations (around line 80-100).
  </action>
  <verify>
Restart server to run migration, then check schema:
```bash
node -e "
const { db } = require('./server/database/schema.js');
const result = db.prepare(\"PRAGMA table_info(employees)\").all();
const languageCol = result.find(col => col.name === 'language');
console.log('Language column:', languageCol);
"
```
Should output language column with type TEXT, default 'he', and NOT NULL constraint.

Test CHECK constraint:
```bash
node -e "
const { db } = require('./server/database/schema.js');
try {
  db.prepare('INSERT INTO employees (name, language) VALUES (?, ?)').run('Test', 'invalid');
  console.log('ERROR: Invalid language accepted');
} catch (e) {
  console.log('OK: CHECK constraint working -', e.message);
}
"
```
Should fail with CHECK constraint error.
  </verify>
  <done>employees table has language column with TEXT type, DEFAULT 'he', and CHECK constraint allowing only he/en/ru/ar.</done>
</task>

<task type="auto">
  <name>Update employee API routes to handle language</name>
  <files>server/routes/employees.js</files>
  <action>
Update employee CRUD endpoints to accept and return language field.

**POST /api/employees (Create):**
Add language to destructuring and INSERT:
```javascript
const { name, phone, position, language } = req.body;

const result = db.prepare(`
  INSERT INTO employees (name, phone, position, language)
  VALUES (?, ?, ?, ?)
`).run(name, phone, position, language || 'he');
```

**PUT /api/employees/:id (Update):**
Add language to destructuring and UPDATE:
```javascript
const { name, phone, position, language } = req.body;

db.prepare(`
  UPDATE employees
  SET name = ?, phone = ?, position = ?, language = ?
  WHERE id = ?
`).run(name, phone, position, language || 'he', req.params.id);
```

**GET endpoints:**
No changes needed - language column will be returned automatically by SELECT * queries.

Validation (optional but recommended):
Add after extracting req.body:
```javascript
if (language && !['he', 'en', 'ru', 'ar'].includes(language)) {
  return res.status(400).json({ error: '×©×¤×” ×œ× ×—×•×§×™×ª. ×‘×—×¨: he, en, ru, ar' });
}
```
  </action>
  <verify>
Test creating employee with language:
```bash
curl -X POST http://localhost:3002/api/employees \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Employee","phone":"0501234567","position":"Tester","language":"en"}'
```
Should return success with language: "en".

Test updating employee language:
```bash
# First get an employee ID
curl http://localhost:3002/api/employees | jq '.[0].id'

# Then update (replace {ID} with actual ID)
curl -X PUT http://localhost:3002/api/employees/{ID} \
  -H "Content-Type: application/json" \
  -d '{"name":"Updated Name","language":"ru"}'
```
Should return success.

Verify in database:
```bash
node -e "
const { db } = require('./server/database/schema.js');
const employees = db.prepare('SELECT id, name, language FROM employees').all();
console.log(employees);
"
```
Should show language column values.
  </verify>
  <done>POST and PUT endpoints accept language field, validate against allowed codes, store in database. GET endpoints return language in response.</done>
</task>

<task type="auto">
  <name>Add language selector to manager UI</name>
  <files>
    client/src/components/EmployeeForm.jsx
    client/src/components/EmployeesPage.jsx
  </files>
  <action>
Add language dropdown to employee creation/editing form.

**In EmployeeForm.jsx:**

1. Add language to form state (if using useState):
```javascript
const [language, setLanguage] = useState(initialEmployee?.language || 'he');
```

2. Add language field in form JSX (after position field, before buttons):
```jsx
<div className="mb-4">
  <label className="block text-sm font-medium text-gray-700 mb-2">
    ×©×¤×”
  </label>
  <select
    value={language}
    onChange={(e) => setLanguage(e.target.value)}
    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
  >
    <option value="he">×¢×‘×¨×™×ª (Hebrew)</option>
    <option value="en">English</option>
    <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹ (Russian)</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
  </select>
  <p className="mt-1 text-sm text-gray-500">
    ×”×©×¤×” ×©×‘×” ×”×¢×•×‘×“ ×™×§×‘×œ ×”×•×“×¢×•×ª ×•×“×¤×™× ××™× ×˜×¨××§×˜×™×‘×™×™×
  </p>
</div>
```

3. Include language in form submission:
```javascript
const employeeData = {
  name,
  phone,
  position,
  language  // Add this
};

// In fetch call:
fetch('/api/employees', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(employeeData)
})
```

**In EmployeesPage.jsx (employee list):**

Add language display to employee card/row (if not already showing all fields):
```jsx
<div className="text-sm text-gray-600">
  <span className="font-medium">×©×¤×”:</span>{' '}
  {employee.language === 'he' && 'ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª'}
  {employee.language === 'en' && 'ğŸ‡¬ğŸ‡§ English'}
  {employee.language === 'ru' && 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹'}
  {employee.language === 'ar' && 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}
</div>
```

Use flag emojis for visual clarity. This helps managers quickly identify employee language preferences.
  </action>
  <verify>
Manual UI verification:
1. Start React dev server: `npm start` in client directory
2. Navigate to Employees page
3. Click "Add Employee" or edit existing employee
4. Verify language dropdown appears with 4 options
5. Create new employee with language "English"
6. Verify employee card shows "ğŸ‡¬ğŸ‡§ English"
7. Edit employee and change to "Russian"
8. Verify update saves and displays "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹"

Check browser console for errors during form submission.
Check Network tab to verify language field sent in POST/PUT request body.
  </verify>
  <done>EmployeeForm has language dropdown with 4 options (he, en, ru, ar), language included in form submission, EmployeesPage displays employee language with flag emoji.</done>
</task>

</tasks>

<verification>
End-to-end language preference flow:

1. **Database schema:**
   ```bash
   node -e "
   const { db } = require('./server/database/schema.js');
   const info = db.prepare('PRAGMA table_info(employees)').all();
   console.log(info.find(col => col.name === 'language'));
   "
   ```

2. **API CRUD with language:**
   ```bash
   # Create employee with English
   curl -X POST http://localhost:3002/api/employees \
     -H "Content-Type: application/json" \
     -d '{"name":"English Speaker","phone":"0501111111","language":"en"}' | jq

   # Get employees and verify language field
   curl http://localhost:3002/api/employees | jq '.[] | {id, name, language}'
   ```

3. **UI workflow (manual):**
   - Open manager UI
   - Create employee with Russian language
   - Verify employee list shows "ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹"
   - Edit employee, change to Arabic
   - Verify update persists and displays "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"

4. **Default behavior:**
   ```bash
   # Create employee without language field
   curl -X POST http://localhost:3002/api/employees \
     -H "Content-Type: application/json" \
     -d '{"name":"Default Lang","phone":"0502222222"}' | jq '.language'
   ```
   Should return "he" (Hebrew default).
</verification>

<success_criteria>
1. employees table has language column with CHECK constraint (he/en/ru/ar only)
2. Default language is 'he' for new employees
3. POST /api/employees accepts language field and stores in DB
4. PUT /api/employees updates language field
5. GET /api/employees returns language field
6. EmployeeForm has language dropdown with 4 options
7. Employee language displays in EmployeesPage with flag emoji
8. Form submission includes language in request body
9. Invalid language codes rejected by CHECK constraint
10. Language preference persists across edits
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-language-support/05-02-SUMMARY.md`

Document:
- Database migration for language column
- Language codes and their meanings (he, en, ru, ar)
- API endpoint changes (POST, PUT)
- UI components updated (EmployeeForm, EmployeesPage)
- Default language behavior (he)
- Next steps: Use employee.language in HTML generation and WhatsApp sending
</output>
