---
phase: 05-multi-language-support
plan: 03
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - server/services/htmlGenerator.js
  - server/templates/task-confirmation.html
autonomous: true

must_haves:
  truths:
    - "Interactive HTML pages generated in employee's language"
    - "Page title, buttons, labels all translated"
    - "HTML dir attribute set to rtl for Hebrew/Arabic, ltr for English/Russian"
    - "Employee sees page in their configured language without JavaScript i18n"
  artifacts:
    - path: "server/services/htmlGenerator.js"
      provides: "Server-side HTML translation using i18n service"
      contains: "getFixedT"
    - path: "server/templates/task-confirmation.html"
      provides: "HTML template with translation placeholders"
      contains: "{{PAGE_TITLE}}"
  key_links:
    - from: "server/services/htmlGenerator.js"
      to: "server/services/i18n.js"
      via: "require and getFixedT call"
      pattern: "require.*i18n.*getFixedT"
    - from: "server/services/htmlGenerator.js"
      to: "employees.language"
      via: "Query employee language from DB"
      pattern: "SELECT.*language.*FROM employees"
---

<objective>
Generate multilingual interactive HTML pages for employees based on their language preference.

Purpose: When employee opens WhatsApp link to interactive task page, they see all UI elements (page title, buttons, labels, placeholders) in their configured language (Hebrew, English, Russian, or Arabic). Text direction (RTL/LTR) automatically adjusts. No client-side JavaScript i18n needed - all translation happens server-side during HTML generation.

Output: Modified htmlGenerator service that queries employee language, translates all strings using i18n service, and generates language-specific HTML with correct dir attribute.
</objective>

<execution_context>
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\workflows\execute-plan.md
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@c:\dev\projects\claude projects\eden claude\.planning\PROJECT.md
@c:\dev\projects\claude projects\eden claude\.planning\ROADMAP.md
@c:\dev\projects\claude projects\eden claude\.planning\STATE.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-RESEARCH.md

# Dependencies
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-01-PLAN.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-02-PLAN.md

# Current implementation
@c:\dev\projects\claude projects\eden claude\server\services\htmlGenerator.js
@c:\dev\projects\claude projects\eden claude\server\templates\task-confirmation.html
</context>

<tasks>

<task type="auto">
  <name>Update HTML template with translation placeholders</name>
  <files>server/templates/task-confirmation.html</files>
  <action>
Update static HTML template to use placeholders for all translatable strings and add dir/lang attributes.

**HTML element attributes:**
Change:
```html
<html lang="he" dir="rtl">
```
To:
```html
<html lang="{{LANGUAGE}}" dir="{{TEXT_DIRECTION}}">
```

**Replace hardcoded Hebrew strings with placeholders:**

Current strings to replace:
1. `<title>משימות לביצוע</title>` → `<title>{{PAGE_TITLE}}</title>`
2. Page heading (h1) → `{{PAGE_TITLE}}`
3. Greeting → `{{GREETING}}`
4. "אישור קבלת כל המשימות" button → `{{ACKNOWLEDGE_BUTTON}}`
5. Button explanation text → `{{ACKNOWLEDGE_DESCRIPTION}}`
6. "שלח השלמה" or "Complete" button → `{{COMPLETE_BUTTON}}`
7. "הערות (אופציונלי)" label → `{{ADD_NOTE_LABEL}}`
8. Textarea placeholder → `{{ADD_NOTE_PLACEHOLDER}}`
9. "צלם תמונה" or "Upload Image" label → `{{UPLOAD_IMAGE_LABEL}}`
10. "עד 5MB, JPG או PNG בלבד" hint → `{{UPLOAD_IMAGE_HINT}}`
11. Success message → `{{TASK_COMPLETED}}`

Search for Hebrew text in the template and replace with descriptive placeholder names in ALL_CAPS wrapped in `{{}}`.

Priority labels (if shown):
- `{{PRIORITY_URGENT}}`, `{{PRIORITY_NORMAL}}`, `{{PRIORITY_OPTIONAL}}`

Time/duration badges:
- `{{BADGE_TIME}}`, `{{BADGE_DURATION}}`, `{{BADGE_COMPLETED}}`

Do NOT change:
- {{API_URL}}, {{TOKEN}}, {{EMPLOYEE_NAME}}, {{TASKS_JSON}} - these are data placeholders, not translations
- JavaScript logic or structure
- CSS styles
  </action>
  <verify>
Check template has translation placeholders:
```bash
grep -o "{{[A-Z_]*}}" "c:\dev\projects\claude projects\eden claude\server\templates\task-confirmation.html" | sort -u
```
Should include: {{LANGUAGE}}, {{TEXT_DIRECTION}}, {{PAGE_TITLE}}, {{GREETING}}, {{ACKNOWLEDGE_BUTTON}}, etc.

No hardcoded Hebrew strings remain:
```bash
grep -E "[\u0590-\u05FF]+" "c:\dev\projects\claude projects\eden claude\server\templates\task-confirmation.html"
```
Should return no results (or only in comments).
  </verify>
  <done>HTML template uses {{PLACEHOLDER}} syntax for all translatable strings, has {{LANGUAGE}} and {{TEXT_DIRECTION}} in html tag, no hardcoded Hebrew text remains.</done>
</task>

<task type="auto">
  <name>Update htmlGenerator to translate and inject strings</name>
  <files>server/services/htmlGenerator.js</files>
  <action>
Modify generateTaskHtml() method to:
1. Query employee language from database
2. Use i18n service to get translations
3. Replace ALL placeholders including new translation placeholders

**At top of file, add i18n import:**
```javascript
const i18n = require('./i18n');
const { db } = require('../database/schema');
```

**Inside generateTaskHtml(data) method, BEFORE reading template:**

```javascript
// Get employee language from database
const confirmation = db.prepare(`
  SELECT employee_id FROM task_confirmations WHERE token = ?
`).get(data.token);

const employee = db.prepare(`
  SELECT language FROM employees WHERE id = ?
`).get(confirmation.employee_id);

const language = employee?.language || 'he';
console.log(`Generating HTML for language: ${language}`);

// Get translations using getFixedT to lock language context
const t = i18n.getFixedT(language, 'tasks');

// Determine text direction: RTL for Hebrew and Arabic, LTR for English and Russian
const textDirection = ['he', 'ar'].includes(language) ? 'rtl' : 'ltr';
```

**After template is loaded, BEFORE existing replacements:**

```javascript
// Translate all UI strings
const translations = {
  PAGE_TITLE: t('pageTitle'),
  GREETING: t('greeting', { name: data.employeeName }),
  ACKNOWLEDGE_BUTTON: t('acknowledgeButton'),
  ACKNOWLEDGE_DESCRIPTION: t('acknowledgeDescription'),
  COMPLETE_BUTTON: t('completeButton'),
  ADD_NOTE_LABEL: t('addNoteLabel'),
  ADD_NOTE_PLACEHOLDER: t('addNotePlaceholder'),
  UPLOAD_IMAGE_LABEL: t('uploadImageLabel'),
  UPLOAD_IMAGE_HINT: t('uploadImageHint'),
  TASK_COMPLETED: t('taskCompleted'),
  PRIORITY_URGENT: t('priority.urgent'),
  PRIORITY_NORMAL: t('priority.normal'),
  PRIORITY_OPTIONAL: t('priority.optional'),
  BADGE_TIME: t('badge.time'),
  BADGE_DURATION: t('badge.duration'),
  BADGE_COMPLETED: t('badge.completed'),
  LANGUAGE: language,
  TEXT_DIRECTION: textDirection
};
```

**Replace template placeholders:**

```javascript
let html = template;

// Replace translation placeholders
Object.keys(translations).forEach(key => {
  const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
  html = html.replace(regex, translations[key]);
});

// Then replace existing data placeholders
html = html
  .replace(/\{\{API_URL\}\}/g, apiUrl)
  .replace(/\{\{TOKEN\}\}/g, data.token)
  .replace(/\{\{EMPLOYEE_NAME\}\}/g, data.employeeName)
  .replace(/\{\{TASKS_JSON\}\}/g, JSON.stringify(data.tasks))
  .replace(/\{\{IS_ACKNOWLEDGED\}\}/g, data.isAcknowledged ? 'true' : 'false')
  .replace(/\{\{ACKNOWLEDGED_AT\}\}/g, data.acknowledgedAt || '');
```

**Error handling:**
Wrap translation loading in try-catch:
```javascript
try {
  const t = i18n.getFixedT(language, 'tasks');
  // ... translations
} catch (error) {
  console.error('Translation error, falling back to Hebrew:', error);
  const t = i18n.getFixedT('he', 'tasks');
  // ... translations
}
```
  </action>
  <verify>
Test HTML generation for each language:

```bash
node -e "
const htmlGenerator = require('./server/services/htmlGenerator.js');
const { db } = require('./server/database/schema.js');
const crypto = require('crypto');

async function test() {
  // Create test employee with English language
  const empId = db.prepare('INSERT INTO employees (name, language) VALUES (?, ?)').run('Test English', 'en').lastInsertRowid;

  // Create test token
  const token = crypto.randomBytes(16).toString('hex');
  db.prepare('INSERT INTO task_confirmations (token, employee_id, task_ids, expires_at) VALUES (?, ?, ?, ?)').run(
    token, empId, JSON.stringify([1]), new Date(Date.now() + 86400000).toISOString()
  );

  // Generate HTML
  const url = await htmlGenerator.generateTaskHtml({
    token: token,
    employeeName: 'Test User',
    tasks: [{id: 1, title: 'Test Task', start_time: '08:00'}],
    isAcknowledged: false,
    acknowledgedAt: null
  });

  console.log('Generated URL:', url);

  // Read generated HTML and check for English strings
  const fs = require('fs');
  const html = fs.readFileSync('./docs/task-' + token + '.html', 'utf8');

  console.log('Contains English greeting:', html.includes('Hello Test User'));
  console.log('Contains English button:', html.includes('Acknowledge Receipt'));
  console.log('HTML lang attribute:', html.match(/lang=\"([^\"]+)\"/)?.[1]);
  console.log('HTML dir attribute:', html.match(/dir=\"([^\"]+)\"/)?.[1]);

  // Cleanup
  db.prepare('DELETE FROM employees WHERE id = ?').run(empId);
  db.prepare('DELETE FROM task_confirmations WHERE token = ?').run(token);
}

test().catch(console.error);
"
```

Should output:
- Contains English greeting: true
- Contains English button: true
- HTML lang attribute: en
- HTML dir attribute: ltr

Repeat test for Russian (ru) and Arabic (ar).
  </verify>
  <done>htmlGenerator queries employee language, uses i18n service with getFixedT to translate all UI strings, replaces template placeholders, sets correct lang and dir attributes, generated HTML shows correct language for employee.</done>
</task>

</tasks>

<verification>
Comprehensive multilingual HTML generation verification:

1. **Hebrew (RTL default):**
   - Create employee with language 'he'
   - Generate HTML via bulk send or direct htmlGenerator call
   - Open generated HTML
   - Verify: page title in Hebrew, dir="rtl", buttons in Hebrew

2. **English (LTR):**
   - Create employee with language 'en'
   - Generate HTML
   - Verify: "Tasks to Complete" title, dir="ltr", "Acknowledge Receipt" button

3. **Russian (LTR):**
   - Create employee with language 'ru'
   - Generate HTML
   - Verify: Cyrillic text, dir="ltr", Russian button labels

4. **Arabic (RTL):**
   - Create employee with language 'ar'
   - Generate HTML
   - Verify: Arabic script, dir="rtl", right-to-left layout

5. **Fallback to Hebrew:**
   - Create employee with no language (NULL or missing)
   - Generate HTML
   - Verify: defaults to Hebrew

6. **Interpolation:**
   - Verify employee name appears correctly in greeting for all languages
   - Check task data still renders (TASKS_JSON not affected)

7. **No Hebrew in English page:**
   ```bash
   grep -E "[\u0590-\u05FF]+" ./docs/task-{english-employee-token}.html
   ```
   Should return no results (no Hebrew text in English page).
</verification>

<success_criteria>
1. HTML template has {{LANGUAGE}} and {{TEXT_DIRECTION}} in html tag
2. All hardcoded Hebrew strings replaced with {{PLACEHOLDER}} syntax
3. htmlGenerator imports i18n service and db
4. htmlGenerator queries employee language from database
5. getFixedT locks translation context per language
6. All translation placeholders replaced with actual translations
7. dir="rtl" for Hebrew and Arabic, dir="ltr" for English and Russian
8. lang attribute matches employee language (he, en, ru, ar)
9. Generated HTML contains no hardcoded Hebrew when employee language is non-Hebrew
10. Employee name interpolation works in all languages
11. Fallback to Hebrew if employee language is NULL or invalid
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-language-support/05-03-SUMMARY.md`

Document:
- Template placeholders added (list key placeholders)
- htmlGenerator changes (i18n import, language query, translation logic)
- RTL/LTR logic (which languages use which direction)
- Example: Show snippet of generated HTML for English vs Hebrew
- Next steps: Apply same pattern to WhatsApp messages
</output>
