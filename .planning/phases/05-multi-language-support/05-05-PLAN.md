---
phase: 05-multi-language-support
plan: 05
type: execute
wave: 3
depends_on: [05-01, 05-02, 05-03, 05-04]
files_modified:
  - package.json
  - server/services/translation.js
  - server/database/schema.js
  - server/routes/taskConfirmation.js
  - client/src/components/TaskCard.jsx
  - client/src/components/HistoryTable.jsx
autonomous: false
user_setup:
  - service: google-cloud-translate
    why: "Automatic translation of employee notes from their language to Hebrew for manager"
    env_vars:
      - name: GOOGLE_APPLICATION_CREDENTIALS
        source: "Google Cloud Console -> IAM & Admin -> Service Accounts -> Create Key (JSON)"
    dashboard_config:
      - task: "Create Google Cloud project"
        location: "console.cloud.google.com -> Create Project"
      - task: "Enable Cloud Translation API"
        location: "console.cloud.google.com -> APIs & Services -> Library -> Cloud Translation API -> Enable"
      - task: "Create service account"
        location: "IAM & Admin -> Service Accounts -> Create Service Account -> Grant 'Cloud Translation API User' role"
      - task: "Download JSON key file"
        location: "Service Accounts -> Your Service Account -> Keys -> Add Key -> Create New Key -> JSON"

must_haves:
  truths:
    - "Employee notes written in their language automatically translated to Hebrew for manager"
    - "Manager sees translation indicator showing original language"
    - "Translation happens when note is saved (not on every view)"
    - "If translation fails, manager sees original note with error indicator"
  artifacts:
    - path: "server/services/translation.js"
      provides: "Google Cloud Translation API wrapper"
      exports: ["translateToHebrew", "detectLanguage"]
    - path: "server/database/schema.js"
      provides: "tasks.original_language column for storing source language"
      contains: "ALTER TABLE tasks ADD COLUMN original_language"
    - path: "server/routes/taskConfirmation.js"
      provides: "Translate completion_note when employee submits"
      contains: "translateToHebrew"
    - path: "client/src/components/TaskCard.jsx"
      provides: "Display translated note with language indicator"
      contains: "ğŸ‡¬ğŸ‡§|ğŸ‡·ğŸ‡º|ğŸ‡¸ğŸ‡¦|original_language"
  key_links:
    - from: "server/routes/taskConfirmation.js"
      to: "server/services/translation.js"
      via: "translateToHebrew call when saving note"
      pattern: "translateToHebrew\\(note"
    - from: "client/src/components/TaskCard.jsx"
      to: "tasks.original_language"
      via: "Display flag emoji based on original_language field"
      pattern: "task\\.original_language"
---

<objective>
Implement automatic translation of employee notes to Hebrew for manager viewing.

Purpose: When an employee writes a note in English, Russian, or Arabic, the manager sees it translated to Hebrew with a clear indicator of the original language. This enables seamless communication without requiring manager to understand multiple languages. Translation happens server-side when note is submitted (not on every view) to minimize API costs.

Output: Translation service integrated with Google Cloud Translation API, database stores original language, manager UI displays translated notes with language indicators (flag emojis).
</objective>

<execution_context>
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\workflows\execute-plan.md
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@c:\dev\projects\claude projects\eden claude\.planning\PROJECT.md
@c:\dev\projects\claude projects\eden claude\.planning\ROADMAP.md
@c:\dev\projects\claude projects\eden claude\.planning\STATE.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-RESEARCH.md

# Dependencies
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-01-PLAN.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-02-PLAN.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-03-PLAN.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-04-PLAN.md

# Current implementation
@c:\dev\projects\claude projects\eden claude\server\routes\taskConfirmation.js
@c:\dev\projects\claude projects\eden claude\client\src\components\TaskCard.jsx
</context>

<tasks>

<task type="auto">
  <name>Install Google Cloud Translation API client</name>
  <files>package.json</files>
  <action>
Install official Google Cloud Translation API client library.

Command:
```bash
cd "c:\dev\projects\claude projects\eden claude"
npm install @google-cloud/translate --save
```

This installs @google-cloud/translate v9.x (API v2 - simpler for basic translation).

Do NOT install @vitalets/google-translate-api (unofficial, rate-limited, not production-ready per RESEARCH.md).

Note: This library requires GOOGLE_APPLICATION_CREDENTIALS environment variable pointing to service account JSON key file. User setup required (see frontmatter user_setup section).
  </action>
  <verify>
```bash
npm list @google-cloud/translate
```
Should show @google-cloud/translate@9.x.x in dependencies.
  </verify>
  <done>package.json contains @google-cloud/translate in dependencies.</done>
</task>

<task type="auto">
  <name>Create translation service wrapper</name>
  <files>server/services/translation.js</files>
  <action>
Create translation service that wraps Google Cloud Translation API with error handling and Hebrew-specific logic.

File: `server/services/translation.js`

Pattern from RESEARCH.md "Automatic Translation Service":

```javascript
const { Translate } = require('@google-cloud/translate').v2;

class TranslationService {
  constructor() {
    // Check if credentials are configured
    if (!process.env.GOOGLE_APPLICATION_CREDENTIALS) {
      console.warn('âš ï¸ GOOGLE_APPLICATION_CREDENTIALS not set - translation will be disabled');
      this.translate = null;
    } else {
      try {
        this.translate = new Translate();
        console.log('âœ“ Google Cloud Translation API initialized');
      } catch (error) {
        console.error('âœ— Failed to initialize Translation API:', error.message);
        this.translate = null;
      }
    }
  }

  /**
   * Translate text to Hebrew
   * @param {string} text - Text to translate
   * @param {string} sourceLanguage - Source language code (en, ru, ar)
   * @returns {Promise<string>} - Translated text in Hebrew
   */
  async translateToHebrew(text, sourceLanguage) {
    if (!text || !text.trim()) {
      return '';
    }

    if (sourceLanguage === 'he') {
      return text; // Already Hebrew, no translation needed
    }

    if (!this.translate) {
      console.warn('Translation API not available, returning original text');
      return text; // Fallback: return original text
    }

    try {
      const [translation] = await this.translate.translate(text, {
        from: sourceLanguage,
        to: 'he'
      });

      console.log(`Translated (${sourceLanguage}â†’he): "${text.substring(0, 50)}..." â†’ "${translation.substring(0, 50)}..."`);
      return translation;
    } catch (error) {
      console.error('Translation error:', error.message);
      // Fallback: return original text with error prefix
      return `[×©×’×™××ª ×ª×¨×’×•×] ${text}`;
    }
  }

  /**
   * Detect language of text
   * @param {string} text - Text to detect
   * @returns {Promise<string>} - Language code (he, en, ru, ar, etc.)
   */
  async detectLanguage(text) {
    if (!text || !text.trim()) {
      return 'he'; // Default to Hebrew for empty text
    }

    if (!this.translate) {
      console.warn('Translation API not available, defaulting to Hebrew');
      return 'he';
    }

    try {
      const [detection] = await this.translate.detect(text);
      const detectedLang = detection.language;
      console.log(`Detected language: ${detectedLang} (confidence: ${detection.confidence})`);
      return detectedLang;
    } catch (error) {
      console.error('Language detection error:', error.message);
      return 'he'; // Default to Hebrew on error
    }
  }
}

// Export singleton instance
module.exports = new TranslationService();
```

Key points:
- Graceful degradation if GOOGLE_APPLICATION_CREDENTIALS not set (logs warning, returns original text)
- Skip translation if source language is Hebrew
- Error handling returns original text with "[×©×’×™××ª ×ª×¨×’×•×]" prefix
- Console logs for debugging translation flow
- Singleton pattern (one instance shared across app)
  </action>
  <verify>
Test translation service (requires GOOGLE_APPLICATION_CREDENTIALS set):

```bash
node -e "
const translation = require('./server/services/translation.js');

async function test() {
  // Test English to Hebrew
  const result1 = await translation.translateToHebrew('Water leak found in bathroom', 'en');
  console.log('ENâ†’HE:', result1);

  // Test Russian to Hebrew
  const result2 = await translation.translateToHebrew('ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° ÑƒÑ‚ĞµÑ‡ĞºĞ° Ğ²Ğ¾Ğ´Ñ‹', 'ru');
  console.log('RUâ†’HE:', result2);

  // Test Hebrew (should return as-is)
  const result3 = await translation.translateToHebrew('× ××¦××” ×“×œ×™×¤×ª ××™×', 'he');
  console.log('HEâ†’HE:', result3);

  // Test language detection
  const lang1 = await translation.detectLanguage('Water leak');
  console.log('Detected:', lang1, '(should be en)');
}

test().catch(console.error);
"
```

Expected output (if credentials configured):
- ENâ†’HE: × ××¦××” ×“×œ×™×¤×ª ××™× ×‘×—×“×¨ ×”×××‘×˜×™×” (or similar Hebrew translation)
- RUâ†’HE: × ××¦××” ×“×œ×™×¤×ª ××™×
- HEâ†’HE: × ××¦××” ×“×œ×™×¤×ª ××™×
- Detected: en (should be en)

If credentials NOT configured:
- Logs warnings, returns original text
  </verify>
  <done>server/services/translation.js exists, exports translateToHebrew and detectLanguage functions, handles missing credentials gracefully, logs translation operations.</done>
</task>

<task type="auto">
  <name>Add original_language column to tasks table</name>
  <files>server/database/schema.js</files>
  <action>
Add column to store the original language of completion notes.

In `server/database/schema.js`, add migration after other task column migrations:

```javascript
// Add original_language column if it doesn't exist (migration for Phase 5 note translation)
try {
  db.exec(`ALTER TABLE tasks ADD COLUMN original_language TEXT CHECK(original_language IN ('he', 'en', 'ru', 'ar'))`);
  console.log('Added original_language column to tasks table');
} catch (e) {
  // Column already exists, ignore error
  if (!e.message.includes('duplicate column name')) {
    console.error('Error adding original_language column:', e.message);
  }
}
```

This column stores the language the employee wrote their note in:
- NULL: No note, or note in Hebrew (default/no translation needed)
- 'en': Note was in English, completion_note contains Hebrew translation
- 'ru': Note was in Russian, completion_note contains Hebrew translation
- 'ar': Note was in Arabic, completion_note contains Hebrew translation

Manager UI uses this to show translation indicator ("ğŸ‡¬ğŸ‡§ ××ª×•×¨×’× ××× ×’×œ×™×ª").
  </action>
  <verify>
Restart server to run migration, then check schema:
```bash
node -e "
const { db } = require('./server/database/schema.js');
const result = db.prepare('PRAGMA table_info(tasks)').all();
const col = result.find(c => c.name === 'original_language');
console.log('original_language column:', col);
"
```
Should output column with type TEXT and CHECK constraint.
  </verify>
  <done>tasks table has original_language column with CHECK constraint (he, en, ru, ar), NULL allowed for no translation.</done>
</task>

<task type="auto">
  <name>Translate notes in task completion endpoint</name>
  <files>server/routes/taskConfirmation.js</files>
  <action>
Update POST /:token/complete endpoint to translate employee notes to Hebrew.

**At top of file, add translation service import:**
```javascript
const translation = require('../services/translation');
```

**In the completion endpoint (around line 143-184), modify note handling:**

Current code:
```javascript
// Save note if provided
if (note && note.trim()) {
  db.prepare(`
    UPDATE tasks SET completion_note = ? WHERE id = ?
  `).run(note.trim(), taskId);
}
```

Replace with:
```javascript
// Save note if provided, translate to Hebrew if needed
if (note && note.trim()) {
  // Get employee language to determine if translation needed
  const task = db.prepare('SELECT employee_id FROM tasks WHERE id = ?').get(taskId);
  const employee = db.prepare('SELECT language FROM employees WHERE id = ?').get(task.employee_id);
  const employeeLanguage = employee?.language || 'he';

  let translatedNote = note.trim();
  let originalLanguage = null;

  if (employeeLanguage !== 'he') {
    // Employee's language is not Hebrew, translate note
    console.log(`Translating note from ${employeeLanguage} to Hebrew...`);
    translatedNote = await translation.translateToHebrew(note.trim(), employeeLanguage);
    originalLanguage = employeeLanguage;
  }

  // Save translated note and original language
  db.prepare(`
    UPDATE tasks SET completion_note = ?, original_language = ? WHERE id = ?
  `).run(translatedNote, originalLanguage, taskId);

  console.log(`Note saved (original language: ${originalLanguage || 'he'})`);
}
```

Make the route handler async:
```javascript
router.post('/:token/complete', upload.single('image'), async (req, res) => {
  // ... existing code
```

Error handling: The translation service already handles errors gracefully (returns original text with "[×©×’×™××ª ×ª×¨×’×•×]" prefix), so no additional try-catch needed here.
  </action>
  <verify>
Test note translation via employee task completion:

1. **Create English employee:**
   ```bash
   curl -X POST http://localhost:3002/api/employees \
     -H "Content-Type: application/json" \
     -d '{"name":"English Test","phone":"0501234567","language":"en"}'
   ```

2. **Assign task, send via WhatsApp, get token from URL**

3. **Complete task with English note:**
   ```bash
   curl -X POST http://localhost:3002/api/confirm/{TOKEN}/complete \
     -F "taskId=123" \
     -F "note=Water leak found in the bathroom"
   ```

4. **Check database:**
   ```bash
   node -e "
   const { db } = require('./server/database/schema.js');
   const task = db.prepare('SELECT completion_note, original_language FROM tasks WHERE id = 123').get();
   console.log('Note:', task.completion_note);
   console.log('Original language:', task.original_language);
   "
   ```
   Should show Hebrew translation of "Water leak found in the bathroom" and original_language = 'en'.

5. **Test Hebrew employee (no translation):**
   - Create Hebrew employee, complete task with Hebrew note
   - Verify completion_note stays in Hebrew, original_language is NULL

6. **Check server logs:**
   Should see: "Translating note from en to Hebrew..." and "Note saved (original language: en)"
  </verify>
  <done>Task completion endpoint translates non-Hebrew notes to Hebrew using translation service, stores translated text in completion_note, stores source language in original_language column.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Translation service integrated with task completion flow. Employee notes in English, Russian, or Arabic are automatically translated to Hebrew and stored with original language indicator.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Set GOOGLE_APPLICATION_CREDENTIALS environment variable pointing to service account JSON key
2. Restart server to load credentials

**Test steps:**

1. **English employee:**
   - Create employee with language='en' via manager UI
   - Assign task to employee
   - Send via WhatsApp
   - Open interactive page (you can do this from desktop browser by visiting the generated URL)
   - Write note in English: "Fixed the leak, replaced pipe section"
   - Click "Submit Completion"
   - Go to manager UI, view task
   - **Verify:** Note shows Hebrew translation with ğŸ‡¬ğŸ‡§ indicator

2. **Russian employee:**
   - Create employee with language='ru'
   - Assign task, send via WhatsApp
   - Open interactive page
   - Write note in Russian: "ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ñ€ĞµÑˆĞµĞ½Ğ°"
   - Submit
   - **Verify:** Manager sees Hebrew translation with ğŸ‡·ğŸ‡º indicator

3. **Hebrew employee (no translation):**
   - Create employee with language='he'
   - Assign task, send via WhatsApp
   - Write note in Hebrew: "×ª×•×§×Ÿ ×‘×”×¦×œ×—×”"
   - Submit
   - **Verify:** Manager sees original Hebrew note, NO translation indicator

4. **Check translation quality:**
   - Does translated text make sense in Hebrew?
   - Are technical terms preserved correctly?
   - Are there any "[×©×’×™××ª ×ª×¨×’×•×]" prefixes (indicates translation failure)?

5. **Server logs:**
   - Check console for "Translating note from en to Hebrew..." messages
   - Check for any translation errors

**Expected results:**
- English/Russian/Arabic notes translated to Hebrew
- Original language stored and displayed
- Hebrew notes unchanged
- Translation indicators visible in UI
- No errors in server logs
  </how-to-verify>
  <resume-signal>
Type "approved" if translation works correctly, or describe any issues found (translation quality, missing indicators, errors, etc.)
  </resume-signal>
</task>

<task type="auto">
  <name>Display translation indicators in manager UI</name>
  <files>
    client/src/components/TaskCard.jsx
    client/src/components/HistoryTable.jsx
  </files>
  <action>
Add visual indicators showing when a note has been translated from another language.

**In TaskCard.jsx (main task list):**

Find where completion_note is displayed (likely in task detail view or expanded card), and wrap with translation indicator:

```jsx
{task.completion_note && (
  <div className="mt-2">
    {task.original_language && task.original_language !== 'he' && (
      <div className="mb-1 text-xs text-gray-500 flex items-center gap-1">
        {task.original_language === 'en' && 'ğŸ‡¬ğŸ‡§'}
        {task.original_language === 'ru' && 'ğŸ‡·ğŸ‡º'}
        {task.original_language === 'ar' && 'ğŸ‡¸ğŸ‡¦'}
        <span>
          ××ª×•×¨×’× ×{task.original_language === 'en' ? '×× ×’×œ×™×ª' : task.original_language === 'ru' ? '×¨×•×¡×™×ª' : '×¢×¨×‘×™×ª'}
        </span>
      </div>
    )}
    <div className="text-sm text-gray-700 bg-gray-50 p-2 rounded">
      {task.completion_note}
    </div>
  </div>
)}
```

**In HistoryTable.jsx (history page):**

Add similar translation indicator in the notes column or detail view:

```jsx
{task.completion_note && (
  <div className="text-sm">
    {task.original_language && task.original_language !== 'he' && (
      <span className="text-xs text-gray-500 mr-1">
        {task.original_language === 'en' && 'ğŸ‡¬ğŸ‡§'}
        {task.original_language === 'ru' && 'ğŸ‡·ğŸ‡º'}
        {task.original_language === 'ar' && 'ğŸ‡¸ğŸ‡¦'}
      </span>
    )}
    {task.completion_note}
  </div>
)}
```

**Styling:**
- Flag emoji for visual recognition
- Small gray text "××ª×•×¨×’× ×..." above note
- Original note content in regular styling
- No indicator if original_language is NULL or 'he' (Hebrew notes)

**Alternative if task doesn't expose completion_note in list view:**
Only show in task detail modal/expanded view. Ensure TaskCard receives original_language field from API (should already be included in task object from JOIN queries).
  </action>
  <verify>
Visual verification in manager UI:

1. **Open manager dashboard**
2. **Find task completed by English employee with note**
   - Should see ğŸ‡¬ğŸ‡§ flag emoji
   - Should see "××ª×•×¨×’× ××× ×’×œ×™×ª" above note
   - Note text in Hebrew

3. **Find task completed by Russian employee with note**
   - Should see ğŸ‡·ğŸ‡º flag emoji
   - Should see "××ª×•×¨×’× ××¨×•×¡×™×ª" above note

4. **Find task completed by Hebrew employee with note**
   - Should NOT see flag emoji or translation indicator
   - Just the note text

5. **Open history page**
   - Filter tasks with notes
   - Verify translation indicators appear consistently
   - Flag emojis render correctly (not as boxes/missing characters)

6. **Responsive check:**
   - View on mobile viewport
   - Indicators should not break layout
   - Flag emojis visible on small screens
  </verify>
  <done>Manager UI displays translation indicators (flag emoji + "××ª×•×¨×’× ×...") for translated notes, no indicator for Hebrew notes, indicators visible in both TaskCard and HistoryTable components.</done>
</task>

</tasks>

<verification>
Complete end-to-end translation flow verification:

1. **Environment setup:**
   - GOOGLE_APPLICATION_CREDENTIALS environment variable set
   - Translation API enabled in Google Cloud Console
   - Service account has "Cloud Translation API User" role

2. **Employee creation:**
   - Create 4 employees: one per language (he, en, ru, ar)

3. **Task assignment and completion:**
   - Assign tasks to all 4 employees
   - Send via WhatsApp
   - Complete each task with note in employee's language:
     - Hebrew: "×ª×•×§×Ÿ ×‘×”×¦×œ×—×”"
     - English: "Fixed successfully"
     - Russian: "Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾"
     - Arabic: "ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­"

4. **Manager view verification:**
   - Hebrew note: No indicator, original text
   - English note: ğŸ‡¬ğŸ‡§ indicator, Hebrew translation
   - Russian note: ğŸ‡·ğŸ‡º indicator, Hebrew translation
   - Arabic note: ğŸ‡¸ğŸ‡¦ indicator, Hebrew translation

5. **Database verification:**
   ```bash
   node -e "
   const { db } = require('./server/database/schema.js');
   const tasks = db.prepare('SELECT id, completion_note, original_language FROM tasks WHERE completion_note IS NOT NULL').all();
   console.log(tasks);
   "
   ```
   Should show original_language values matching employee languages.

6. **Translation quality:**
   - Hebrew translations make sense semantically
   - Technical terms preserved
   - No "[×©×’×™××ª ×ª×¨×’×•×]" errors (unless API credentials missing)

7. **Fallback behavior:**
   - Temporarily unset GOOGLE_APPLICATION_CREDENTIALS
   - Complete task with English note
   - Verify original text saved (no translation, no crash)
   - Re-set credentials, verify normal translation resumes
</verification>

<success_criteria>
1. @google-cloud/translate installed in package.json
2. server/services/translation.js exists, exports translateToHebrew and detectLanguage
3. Translation service handles missing credentials gracefully
4. tasks.original_language column exists with CHECK constraint
5. Task completion endpoint is async
6. Task completion endpoint translates non-Hebrew notes
7. Translated note stored in completion_note, source language in original_language
8. Hebrew notes not translated, original_language stays NULL
9. Manager UI shows translation indicators (flag + text)
10. TaskCard displays translation indicator above note
11. HistoryTable displays translation indicator in notes column
12. No indicators shown for Hebrew notes
13. Translation errors logged but don't crash server
14. Checkpoint approved: translation quality acceptable, indicators visible
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-language-support/05-05-SUMMARY.md`

Document:
- Translation service architecture (Google Cloud Translation API wrapper)
- Database schema addition (original_language column)
- Translation flow (employee submits â†’ detect language â†’ translate â†’ store)
- UI indicator implementation (flag emojis, "××ª×•×¨×’× ×..." text)
- Example translations (English â†’ Hebrew, Russian â†’ Hebrew)
- User setup completed (Google Cloud credentials)
- Fallback behavior (missing credentials, translation errors)
- Cost implications (Translation API pricing: $20/1M characters)
- Next steps: Monitor translation usage, consider caching if costs increase
</output>
