---
phase: 05-multi-language-support
plan: 04
type: execute
wave: 2
depends_on: [05-01, 05-02]
files_modified:
  - server/routes/whatsapp.js
autonomous: true

must_haves:
  truths:
    - "WhatsApp messages sent in employee's configured language"
    - "Greeting, headers, labels all translated"
    - "Task list structure preserved across languages"
    - "Link message clear in all languages"
  artifacts:
    - path: "server/routes/whatsapp.js"
      provides: "Multilingual WhatsApp message generation"
      contains: "getFixedT"
  key_links:
    - from: "server/routes/whatsapp.js"
      to: "server/services/i18n.js"
      via: "require and getFixedT for translation"
      pattern: "require.*i18n.*getFixedT"
    - from: "server/routes/whatsapp.js"
      to: "employees.language"
      via: "Read language from tasksByEmployee data"
      pattern: "data\\.language"
---

<objective>
Send WhatsApp messages in employee's configured language.

Purpose: When manager sends tasks via WhatsApp, each employee receives message in their preferred language (Hebrew, English, Russian, or Arabic). Greeting, task list header, field labels ("Time:", "Description:"), and call-to-action are all translated. This ensures employees understand task assignments regardless of Hebrew proficiency.

Output: Modified /send-bulk endpoint that uses i18n service to translate WhatsApp message templates based on employee language.
</objective>

<execution_context>
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\workflows\execute-plan.md
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@c:\dev\projects\claude projects\eden claude\.planning\PROJECT.md
@c:\dev\projects\claude projects\eden claude\.planning\ROADMAP.md
@c:\dev\projects\claude projects\eden claude\.planning\STATE.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-RESEARCH.md

# Dependencies
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-01-PLAN.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\05-multi-language-support\05-02-PLAN.md

# Current implementation
@c:\dev\projects\claude projects\eden claude\server\routes\whatsapp.js
</context>

<tasks>

<task type="auto">
  <name>Translate WhatsApp messages using i18n</name>
  <files>server/routes/whatsapp.js</files>
  <action>
Update POST /send-bulk endpoint to translate WhatsApp messages based on employee language.

**At top of file, add i18n import:**
```javascript
const i18n = require('../services/i18n');
```

**Inside the for loop (around line 164), BEFORE building message:**

Currently sends hardcoded Hebrew:
```javascript
const { phone, name, tasks, date } = data;
```

Add employee language query:
```javascript
const { phone, name, tasks, date, language } = data;
const employeeLanguage = language || 'he';
console.log(`Employee ${name} language: ${employeeLanguage}`);

// Get translations for this employee's language
const t = i18n.getFixedT(employeeLanguage, 'whatsapp');
```

**Replace hardcoded message building (lines 226-238):**

Old:
```javascript
let message = `◊©◊ú◊ï◊ù ${name},\n\n`;
message += `◊û◊©◊ô◊û◊ï◊™ ◊ú◊ô◊ï◊ù ${date}:\n\n`;

sortedTasks.forEach((task, index) => {
  message += `${index + 1}. ${task.start_time} - ${task.title}\n`;
  if (task.description) {
    message += `   ${task.description}\n`;
  }
  message += '\n';
});

message += `\nüì± *◊ú◊¶◊§◊ô◊ô◊î ◊ê◊ô◊†◊ò◊®◊ß◊ò◊ô◊ë◊ô◊™ ◊ï◊ê◊ô◊©◊ï◊® ◊ß◊ë◊ú◊î - ◊ß◊ô◊©◊ï◊® ◊ô◊í◊ô◊¢ ◊ë◊î◊ï◊ì◊¢◊î ◊î◊ë◊ê◊î*`;
```

New:
```javascript
// Build translated message
let message = t('greeting', { name }) + '\n\n';
message += t('taskListHeader', { date, count: tasks.length }) + '\n\n';

sortedTasks.forEach((task, index) => {
  message += `${index + 1}. ${task.start_time} - ${task.title}\n`;
  if (task.description) {
    message += `   ${task.description}\n`;
  }
  message += '\n';
});

message += '\nüì± ' + t('clickToView');
```

**Ensure tasksByEmployee includes language:**

In the client-side code that calls /send-bulk (likely in a React component), ensure employee object includes language field. If not already included, modify the bulk send logic to fetch employee language from database.

The endpoint receives:
```javascript
tasksByEmployee: {
  [employeeId]: {
    phone: "...",
    name: "...",
    tasks: [...],
    date: "...",
    language: "en"  // <- MUST be included
  }
}
```

If client doesn't send language, query it server-side:
```javascript
// Inside for loop, after extracting data
let { phone, name, tasks, date, language } = data;

if (!language) {
  // Fallback: query language from database
  const employee = db.prepare('SELECT language FROM employees WHERE id = ?').get(employeeId);
  language = employee?.language || 'he';
  console.log(`Language not provided in request, queried from DB: ${language}`);
}
```
  </action>
  <verify>
Manual testing with different language employees:

1. **Create test employees:**
   ```bash
   curl -X POST http://localhost:3002/api/employees \
     -H "Content-Type: application/json" \
     -d '{"name":"English Worker","phone":"0501111111","language":"en"}'

   curl -X POST http://localhost:3002/api/employees \
     -H "Content-Type: application/json" \
     -d '{"name":"Russian Worker","phone":"0502222222","language":"ru"}'
   ```

2. **Send bulk tasks via manager UI:**
   - Create tasks for English Worker
   - Click "Send via WhatsApp"
   - Check WhatsApp Web or phone
   - Verify message shows "Hello English Worker" not "◊©◊ú◊ï◊ù English Worker"
   - Verify task list header in English

3. **Check console logs:**
   Server should log:
   ```
   Employee English Worker language: en
   Sending task list message...
   ```

4. **Test Russian employee:**
   - Send tasks to Russian Worker
   - Verify message uses Cyrillic characters
   - Verify greeting is "–ü—Ä–∏–≤–µ—Ç Russian Worker"

5. **Fallback test:**
   - Create employee without language field
   - Send tasks
   - Verify defaults to Hebrew message

6. **Translation accuracy:**
   Check received WhatsApp messages match translation files (src/locales/*/whatsapp.json).
  </verify>
  <done>WhatsApp messages translated using i18n service, employee language read from database, greeting and headers in correct language, task data preserved, link message translated.</done>
</task>

</tasks>

<verification>
Comprehensive WhatsApp multilingual verification:

1. **Hebrew employee (default):**
   - Create employee with language='he' or NULL
   - Send tasks
   - Receive: "◊©◊ú◊ï◊ù [name], ◊û◊©◊ô◊û◊ï◊™ ◊ú◊ô◊ï◊ù..."

2. **English employee:**
   - Create employee with language='en'
   - Send tasks
   - Receive: "Hello [name], Tasks for [date]..."
   - No Hebrew characters in message

3. **Russian employee:**
   - Create employee with language='ru'
   - Send tasks
   - Receive: "–ü—Ä–∏–≤–µ—Ç [name], –ó–∞–¥–∞—á–∏ –Ω–∞ [date]..."
   - Cyrillic text for all labels

4. **Arabic employee:**
   - Create employee with language='ar'
   - Send tasks
   - Receive: Arabic greeting and headers
   - WhatsApp displays RTL correctly (WhatsApp handles RTL automatically)

5. **Task data unchanged:**
   - Task titles and descriptions remain as entered (not translated)
   - Only template strings (greeting, headers, labels) translated
   - Times and dates displayed consistently

6. **Multiple employees in one bulk send:**
   - Send tasks to 3 employees: one Hebrew, one English, one Russian
   - Each receives message in their language
   - No language mixing (no English employee getting Hebrew message)

7. **Server logs verification:**
   ```
   Employee X language: en
   Employee Y language: ru
   Employee Z language: he
   ```
</verification>

<success_criteria>
1. whatsapp.js imports i18n service
2. /send-bulk endpoint extracts employee language from data or queries DB
3. getFixedT locks translation context per employee
4. WhatsApp message greeting uses t('greeting', {name})
5. Task list header uses t('taskListHeader', {date, count})
6. Click-to-view message uses t('clickToView')
7. Employee receives message in configured language
8. Fallback to Hebrew if language missing or invalid
9. Multiple employees in same bulk send each get correct language
10. Task titles and descriptions not translated (preserved as-is)
11. No translation errors in server logs
</success_criteria>

<output>
After completion, create `.planning/phases/05-multi-language-support/05-04-SUMMARY.md`

Document:
- WhatsApp message translation pattern (getFixedT usage)
- Language fallback logic (defaults to 'he')
- Example messages in each language (screenshot or text snippet)
- Translation keys used (greeting, taskListHeader, clickToView)
- Next steps: Note translation service for employee-to-manager communication
</output>
