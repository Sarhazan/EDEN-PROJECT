---
phase: 01-stars-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/database/schema.js
  - server/routes/tasks.js
autonomous: true

must_haves:
  truths:
    - "Database stores starred status for each task"
    - "Star status persists across server restarts"
    - "API accepts star toggle requests"
  artifacts:
    - path: "server/database/schema.js"
      provides: "is_starred column migration"
      min_lines: 10
    - path: "server/routes/tasks.js"
      provides: "Star toggle endpoint"
      exports: ["PUT /tasks/:id/star"]
  key_links:
    - from: "server/routes/tasks.js"
      to: "server/database/schema.js"
      via: "SQLite update statement"
      pattern: "UPDATE tasks SET is_starred"
---

<objective>
Add database and backend support for starring tasks

Purpose: Enable persistent storage of which tasks are marked as important by managers
Output: Database column + API endpoint for toggling star status
</objective>

<execution_context>
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\workflows\execute-plan.md
@c:\dev\projects\claude projects\eden claude\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@c:\dev\projects\claude projects\eden claude\.planning\PROJECT.md
@c:\dev\projects\claude projects\eden claude\.planning\ROADMAP.md
@c:\dev\projects\claude projects\eden claude\.planning\STATE.md
@c:\dev\projects\claude projects\eden claude\.planning\phases\01-stars-system\01-CONTEXT.md

# Existing backend patterns
@c:\dev\projects\claude projects\eden claude\server\database\schema.js
@c:\dev\projects\claude projects\eden claude\server\routes\tasks.js
</context>

<tasks>

<task type="auto">
  <name>Add is_starred column to tasks table</name>
  <files>server/database/schema.js</files>
  <action>
Add `is_starred` boolean column to tasks table using existing migration pattern.

Implementation:
- Add migration block after line 293 (after translation_provider migration)
- Column: `is_starred BOOLEAN DEFAULT 0`
- Use same try/catch pattern as existing migrations (lines 104-112)
- Log success message: "Added is_starred column to tasks table"

Why this approach:
- SQLite doesn't have native boolean type - uses INTEGER (0/1)
- DEFAULT 0 ensures existing tasks are unstarred
- Try/catch handles "duplicate column" error for re-runs
- Follows established migration pattern from lines 104-293
  </action>
  <verify>
Run `npm start` in server directory - should see log "Added is_starred column to tasks table" or no error.
Query: `sqlite3 maintenance.db "PRAGMA table_info(tasks);"` - should show is_starred column.
  </verify>
  <done>
Database has is_starred column, default value 0, visible in schema.
  </done>
</task>

<task type="auto">
  <name>Create star toggle API endpoint</name>
  <files>server/routes/tasks.js</files>
  <action>
Add PUT endpoint at `/tasks/:id/star` to toggle is_starred status.

Implementation details:
- Add route after line 668 (after delete route)
- Toggle logic: `is_starred = CASE WHEN is_starred = 1 THEN 0 ELSE 1 END`
- Return updated task with JOIN (system_name, employee_name, location_name)
- Enrich task with timing info using `enrichTaskWithTiming()`
- Broadcast via Socket.IO: `io.emit('task:updated', { task: enrichedTask })`
- Return 404 if task not found

Why this approach:
- Toggle in SQL avoids race conditions (no read-then-write)
- Follows existing pattern from PUT `/tasks/:id/status` (lines 541-668)
- Socket.IO broadcast updates all connected clients in real-time
- Enrichment includes timing info (late status, minutes remaining)
  </action>
  <verify>
Test with curl:
```bash
curl -X PUT http://localhost:3002/api/tasks/1/star
```
Should return task object with is_starred toggled. Repeat to toggle back.
  </verify>
  <done>
API endpoint exists, toggles star status, broadcasts via WebSocket, returns enriched task.
  </done>
</task>

<task type="auto">
  <name>Include is_starred in all task queries</name>
  <files>server/routes/tasks.js</files>
  <action>
Ensure is_starred column is selected in all existing task queries.

Update these SELECT statements to include `t.is_starred`:
- Line 123: GET / (all tasks)
- Line 143: GET /today
- Line 285: GET /overdue
- Line 304: GET /:id (single task)
- Line 452: POST / (create - after insert)
- Line 479: POST / (create non-recurring)
- Line 518: PUT /:id (update task)
- Line 648: PUT /:id/status (status update)
- Line 676: DELETE /:id (before delete)

Why this approach:
- Tasks already have is_starred in database after migration
- SELECT t.* includes is_starred automatically (SQLite expands *)
- This is defensive - ensures column explicitly returned in JOINs
- No functional change, just clarity for future maintenance
  </action>
  <verify>
Test GET /api/tasks - response should include `"is_starred": 0` or `"is_starred": 1` for each task.
Test after toggling a star - starred task should show `"is_starred": 1`.
  </verify>
  <done>
All task API responses include is_starred field with correct boolean value (0 or 1).
  </done>
</task>

</tasks>

<verification>
Run full verification sequence:
1. Server starts without errors, migration logs appear
2. Database schema shows is_starred column: `sqlite3 maintenance.db "PRAGMA table_info(tasks);"`
3. GET /api/tasks returns tasks with is_starred: 0 by default
4. PUT /api/tasks/1/star toggles is_starred to 1
5. PUT /api/tasks/1/star again toggles back to 0
6. WebSocket event 'task:updated' fires when star toggled (check browser console)
</verification>

<success_criteria>
- Database migration completes without errors
- All tasks have is_starred column (defaults to 0)
- Star toggle endpoint responds with updated task
- Socket.IO broadcasts star changes to connected clients
- Existing task CRUD operations unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/01-stars-system/01-01-SUMMARY.md`
</output>
