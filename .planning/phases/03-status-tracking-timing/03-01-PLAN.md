---
phase: 03-status-tracking-timing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/database/schema.js
  - server/routes/taskConfirmation.js
  - server/routes/tasks.js
autonomous: true

must_haves:
  truths:
    - "Tasks have estimated duration field in database"
    - "System saves exact completion timestamp when worker finishes task"
    - "Backend calculates estimated end time from start + duration"
  artifacts:
    - path: "server/database/schema.js"
      provides: "estimated_duration_minutes and completed_at columns"
      contains: "ALTER TABLE tasks ADD COLUMN"
    - path: "server/routes/taskConfirmation.js"
      provides: "Saves completed_at timestamp on task completion"
      pattern: "getCurrentTimestampIsrael"
    - path: "server/routes/tasks.js"
      provides: "Helper function to calculate estimated end time"
      exports: ["calculateEstimatedEnd"]
  key_links:
    - from: "server/routes/taskConfirmation.js"
      to: "server/utils/dateUtils.js"
      via: "getCurrentTimestampIsrael function"
      pattern: "getCurrentTimestampIsrael\\(\\)"
    - from: "server/routes/tasks.js"
      to: "date-fns"
      via: "addMinutes for duration calculation"
      pattern: "addMinutes\\("
---

<objective>
Add database fields and backend logic for tracking task duration, estimated end time, and actual completion timestamp.

Purpose: Foundation for timing calculations - stores source data (duration estimate, completion time) that subsequent plans will use to calculate late status and display timing information.

Output: Database schema with timing columns, backend functions to calculate estimated end time, completion timestamp saved when worker finishes task.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-status-tracking-timing/03-RESEARCH.md

# Prior phase infrastructure
@.planning/phases/01-real-time-infrastructure/01-02-SUMMARY.md
@.planning/phases/02-enhanced-task-completion/02-01-SUMMARY.md

# Key files to modify
@server/database/schema.js
@server/routes/taskConfirmation.js
@server/routes/tasks.js
@server/utils/dateUtils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timing columns to database schema</name>
  <files>server/database/schema.js</files>
  <action>
    Add two new columns to tasks table via migration pattern (same pattern used for completion_note):

    1. estimated_duration_minutes INTEGER DEFAULT 30
       - Stores how long task should take (in minutes)
       - Default 30 minutes (standard for maintenance tasks)
       - Allows NULL for backwards compatibility with existing tasks

    2. completed_at TIMESTAMP
       - Stores exact timestamp when worker completes task
       - NULL until task is completed
       - Will be populated by taskConfirmation.js endpoint

    Use try/catch migration pattern already established in schema.js:
    ```javascript
    try {
      db.exec(`ALTER TABLE tasks ADD COLUMN estimated_duration_minutes INTEGER DEFAULT 30`);
    } catch (e) {
      // Column already exists, ignore error
    }
    ```

    Do the same for completed_at column.

    Do NOT add a "late" status column - late status will be calculated dynamically (per RESEARCH.md anti-patterns).
  </action>
  <verify>
    1. Server starts without errors: `cd server && node index.js`
    2. Check database schema: Open maintenance.db and verify columns exist
    3. Check console output: Should log "Database tables initialized successfully"
  </verify>
  <done>
    Database schema updated with estimated_duration_minutes (INTEGER DEFAULT 30) and completed_at (TIMESTAMP) columns in tasks table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Save completed_at timestamp when worker completes task</name>
  <files>server/routes/taskConfirmation.js</files>
  <action>
    Modify the POST /api/confirm/:token/complete endpoint to save completion timestamp:

    1. Import getCurrentTimestampIsrael from '../utils/dateUtils' (already used for sent_at in tasks.js)
    2. Before updating task status to 'pending_approval', capture timestamp:
       ```javascript
       const completedAt = getCurrentTimestampIsrael();
       ```
    3. Update the db.prepare UPDATE statement to include completed_at:
       ```sql
       UPDATE tasks
       SET status = 'pending_approval', completed_at = ?
       WHERE id = ?
       ```
       And pass completedAt as parameter: `.run(completedAt, taskId)`

    This ensures exact completion time is captured when worker clicks "סיים משימה" in interactive page.

    Do NOT modify the manager approval endpoint (/tasks/:id/approve) - that endpoint changes status from pending_approval to completed, but actual completion time was already recorded when worker finished.
  </action>
  <verify>
    1. Check taskConfirmation.js imports getCurrentTimestampIsrael
    2. Verify UPDATE statement includes completed_at column
    3. Server starts without errors
    4. Test with curl (if time allows): POST to complete endpoint and verify completed_at is populated in database
  </verify>
  <done>
    Worker completion saves completed_at timestamp using getCurrentTimestampIsrael(), ensuring timezone-accurate completion time for variance calculations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create backend helper to calculate estimated end time</name>
  <files>server/routes/tasks.js</files>
  <action>
    Add a helper function at the top of tasks.js (after imports, before routes):

    ```javascript
    /**
     * Calculate estimated end time for a task
     * @param {Object} task - Task object with start_date, start_time, estimated_duration_minutes
     * @returns {Date} Estimated end time as Date object
     */
    function calculateEstimatedEnd(task) {
      const taskStart = new Date(`${task.start_date}T${task.start_time}`);
      const durationMinutes = task.estimated_duration_minutes || 30;
      return addMinutes(taskStart, durationMinutes);
    }
    ```

    This function will be used in Plan 02 to determine if tasks are late.

    date-fns addMinutes is already imported at the top of tasks.js, so no new imports needed.

    Do NOT modify any routes yet - this is just infrastructure for Plan 02.
  </action>
  <verify>
    1. Function exists in tasks.js after imports
    2. Uses addMinutes from date-fns (already imported)
    3. Handles default duration (30 minutes) if estimated_duration_minutes is NULL
    4. Server starts without errors
  </verify>
  <done>
    Backend has calculateEstimatedEnd helper function ready to calculate task end times based on start time + estimated duration.
  </done>
</task>

</tasks>

<verification>
1. Database schema has new columns: `SELECT * FROM pragma_table_info('tasks') WHERE name IN ('estimated_duration_minutes', 'completed_at');`
2. Server starts cleanly without migration errors
3. taskConfirmation.js saves completed_at timestamp when worker completes task
4. tasks.js has calculateEstimatedEnd helper function
5. No changes to existing functionality - all existing features still work
</verification>

<success_criteria>
1. Database schema updated with timing columns without breaking existing tasks
2. Worker task completion captures exact timestamp in Israel timezone
3. Backend has reusable function to calculate estimated end time from start + duration
4. All existing Phase 1 and Phase 2 functionality continues to work (WebSocket, uploads, notes)
5. Foundation ready for Plan 02 to add late detection logic
</success_criteria>

<output>
After completion, create `.planning/phases/03-status-tracking-timing/03-01-SUMMARY.md` documenting:
- Database columns added
- Completion timestamp implementation
- Helper function created
- Any deviations from plan
- Requirements satisfied: TS-01 (duration field), TS-02 (estimated end calculation infrastructure), TS-06 (completed_at timestamp)
</output>
