---
phase: 03-status-tracking-timing
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
  - 03-02
files_modified:
  - client/src/components/shared/TaskCard.jsx
  - client/src/pages/MyDayPage.jsx
autonomous: false

user_setup: []

must_haves:
  truths:
    - "Manager sees red-styled late tasks in UI"
    - "Manager sees countdown timer showing minutes remaining or overdue"
    - "Manager sees completion variance for finished tasks"
    - "UI updates every minute to refresh countdown without page reload"
    - "Late tasks have distinct red border and background"
  artifacts:
    - path: "client/src/components/shared/TaskCard.jsx"
      provides: "Timing display section with countdown/overdue text"
      contains: "timing-info"
      min_lines: 400
    - path: "client/src/pages/MyDayPage.jsx"
      provides: "setInterval for minute-level UI updates"
      pattern: "setInterval.*60000"
  key_links:
    - from: "TaskCard.jsx"
      to: "task.is_late"
      via: "Conditional red styling"
      pattern: "task\\.is_late.*border-red"
    - from: "MyDayPage.jsx"
      to: "setCurrentTime"
      via: "Forces re-render every 60 seconds"
      pattern: "setCurrentTime\\(new Date\\(\\)\\)"
---

<objective>
Display timing information in manager UI with color-coded late indicators, countdown timers, and completion variance.

Purpose: Make task timing status immediately visible to manager - red for late tasks, countdown for tasks in progress, completion variance for finished tasks.

Output: TaskCard shows timing information with appropriate colors, MyDayPage updates countdown every minute, manager can see at a glance which tasks are late.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-status-tracking-timing/03-RESEARCH.md

# Backend timing infrastructure from Wave 1
@.planning/phases/03-status-tracking-timing/03-01-PLAN.md
@.planning/phases/03-status-tracking-timing/03-02-PLAN.md

# Files to modify
@client/src/components/shared/TaskCard.jsx
@client/src/pages/MyDayPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timing display section to TaskCard</name>
  <files>client/src/components/shared/TaskCard.jsx</files>
  <action>
    Add timing display after the employee section (around line 316, after the employee onClick block):

    ```javascript
    {/* Timing information section */}
    {task.status !== 'completed' && (task.is_late !== undefined || task.minutes_remaining !== undefined) && (
      <div className="timing-info mt-3 pt-3 border-t border-gray-200">
        {task.is_late ? (
          <div className="flex items-center gap-2">
            <span className="text-2xl">â°</span>
            <div>
              <div className="text-sm font-semibold text-red-600">
                ×‘××™×—×•×¨ {task.minutes_remaining} ×“×§×•×ª
              </div>
              <div className="text-xs text-gray-500">
                ×”×™×” ×¦×¨×™×š ×œ×”×¡×ª×™×™× ×‘-{task.estimated_end_time}
              </div>
            </div>
          </div>
        ) : task.timing_status === 'near-deadline' ? (
          <div className="flex items-center gap-2">
            <span className="text-2xl">âš ï¸</span>
            <div>
              <div className="text-sm font-semibold text-yellow-600">
                × ×©××¨×• {task.minutes_remaining} ×“×§×•×ª
              </div>
              <div className="text-xs text-gray-500">
                ×¡×™×•× ××•×¢×¨×š: {task.estimated_end_time}
              </div>
            </div>
          </div>
        ) : (
          <div className="flex items-center gap-2">
            <span className="text-2xl">âœ…</span>
            <div>
              <div className="text-sm text-gray-600">
                × ×©××¨×• {task.minutes_remaining} ×“×§×•×ª
              </div>
              <div className="text-xs text-gray-500">
                ×¡×™×•× ××•×¢×¨×š: {task.estimated_end_time}
              </div>
            </div>
          </div>
        )}
      </div>
    )}

    {/* Completion variance for completed tasks */}
    {task.status === 'completed' && task.time_delta_text && (
      <div className="timing-info mt-3 pt-3 border-t border-gray-200">
        <div className="flex items-center gap-2">
          <span className="text-2xl">
            {task.time_delta_minutes < 0 ? 'ğŸ‰' : task.time_delta_minutes > 0 ? 'â±ï¸' : 'âœ…'}
          </span>
          <div className={`text-sm font-semibold ${
            task.time_delta_minutes < 0 ? 'text-green-600' :
            task.time_delta_minutes > 0 ? 'text-orange-600' :
            'text-gray-600'
          }`}>
            {task.time_delta_text}
          </div>
        </div>
      </div>
    )}
    ```

    Place this AFTER the employee section and BEFORE the existing completion data section (if exists).

    This displays:
    - Red "×‘××™×—×•×¨ X ×“×§×•×ª" for late tasks
    - Yellow "× ×©××¨×• X ×“×§×•×ª" for near-deadline tasks
    - Gray "× ×©××¨×• X ×“×§×•×ª" for on-time tasks
    - Green/orange completion variance for finished tasks
  </action>
  <verify>
    1. Timing section exists in TaskCard.jsx
    2. Uses task.is_late, task.minutes_remaining, task.timing_status from backend
    3. Shows estimated_end_time
    4. Displays time_delta_text for completed tasks
    5. Client compiles without errors: `cd client && npm run dev`
  </verify>
  <done>
    TaskCard displays timing information with countdown for in-progress tasks and completion variance for finished tasks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add red styling for late tasks</name>
  <files>client/src/components/shared/TaskCard.jsx</files>
  <action>
    Modify the main TaskCard div (around line 148) to add red border/background for late tasks:

    Find the existing div with className:
    ```javascript
    <div className={`
      bg-white rounded-xl shadow-md p-5
      transition-all duration-200
      hover:shadow-lg hover:-translate-y-1 hover:scale-[1.01]
      ${task.status === 'completed' ? 'opacity-70' : ''}
      ${task.status === 'pending_approval' ? 'task-pending-approval' : ''}
      ${task.priority === 'urgent' ? 'border-r-4 border-rose-500' : ''}
    `}>
    ```

    Add late task styling BEFORE the priority urgent check:
    ```javascript
    <div className={`
      bg-white rounded-xl shadow-md p-5
      transition-all duration-200
      hover:shadow-lg hover:-translate-y-1 hover:scale-[1.01]
      ${task.status === 'completed' ? 'opacity-70' : ''}
      ${task.status === 'pending_approval' ? 'task-pending-approval' : ''}
      ${task.is_late ? 'border-l-4 border-red-500 bg-red-50' : ''}
      ${task.timing_status === 'near-deadline' && !task.is_late ? 'border-l-4 border-yellow-500' : ''}
      ${task.priority === 'urgent' && !task.is_late && task.timing_status !== 'near-deadline' ? 'border-r-4 border-rose-500' : ''}
    `}>
    ```

    This creates visual hierarchy:
    1. Late tasks: Red left border + red background (highest priority)
    2. Near-deadline tasks: Yellow left border
    3. Urgent priority tasks: Rose right border (only if not late/near-deadline)

    Late tasks get left border (not right) to distinguish from priority urgent styling.
  </action>
  <verify>
    1. TaskCard div className includes task.is_late conditional
    2. Late tasks get 'border-l-4 border-red-500 bg-red-50'
    3. Near-deadline tasks get 'border-l-4 border-yellow-500'
    4. Priority styling adjusted to not conflict with timing styling
    5. Client compiles and renders correctly
  </verify>
  <done>
    Late tasks display with red left border and red background, making them immediately visible to manager. Near-deadline tasks show yellow left border.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add minute-level countdown updates to MyDayPage</name>
  <files>client/src/pages/MyDayPage.jsx</files>
  <action>
    Add setInterval to update UI every 60 seconds (keeping countdown timers current):

    1. Import useState and useEffect at top (may already be imported):
       ```javascript
       import { useState, useEffect } from 'react';
       ```

    2. Add state for current time (add near the top of MyDayPage component, after other useState declarations):
       ```javascript
       const [currentTime, setCurrentTime] = useState(new Date());
       ```

    3. Add useEffect with setInterval (place after other useEffect hooks):
       ```javascript
       // Update current time every minute to refresh countdown displays
       useEffect(() => {
         const interval = setInterval(() => {
           setCurrentTime(new Date());
         }, 60000); // 60 seconds

         return () => clearInterval(interval);
       }, []);
       ```

    This forces React to re-render MyDayPage every 60 seconds, which re-renders all TaskCard components, updating their countdown displays. The backend's enrichTaskWithTiming calculates fresh is_late and minutes_remaining on each render.

    Note: We don't need to use currentTime variable anywhere - just updating state triggers re-render, and TaskCard reads fresh task.is_late / task.minutes_remaining from props.

    Per RESEARCH.md, 60-second interval is optimal (1-second causes performance issues, 60 seconds is sufficient for maintenance task timing).
  </action>
  <verify>
    1. MyDayPage imports useState and useEffect
    2. currentTime state exists
    3. useEffect with setInterval(60000) exists
    4. Cleanup function (clearInterval) present
    5. Client compiles without errors
    6. Browser DevTools shows no excessive re-renders (should be once per minute)
  </verify>
  <done>
    MyDayPage updates every 60 seconds, refreshing countdown timers and late status for all displayed tasks without page reload.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete timing display system with late detection, countdown timers, and color-coded visual indicators in manager UI.

    Backend (Plans 01-02):
    - Database columns: estimated_duration_minutes, completed_at
    - Dynamic late detection based on estimated end time
    - Completion time variance calculation (early/on-time/late)
    - Real-time timing data in Socket.IO broadcasts

    Frontend (Plan 03):
    - Red styling for late tasks (border + background)
    - Countdown display showing minutes remaining or overdue
    - Completion variance display for finished tasks
    - Auto-refresh every 60 seconds
  </what-built>
  <how-to-verify>
    **Setup:**
    1. Start backend: `cd server && node index.js`
    2. Start frontend: `cd client && npm run dev`
    3. Open browser: http://localhost:5174

    **Test Scenario 1: Create task with short duration (will become late quickly)**
    1. Go to "××©×™××•×ª ×”×™×•×" page
    2. Create new task:
       - Title: "×‘×“×™×§×ª ××™×—×•×¨"
       - Start date: Today
       - Start time: 2 minutes ago (e.g., if now is 14:30, set 14:28)
       - Duration: 1 minute (should show estimated_duration_minutes field in form)
       - Assign to any employee
    3. Expected: Task appears with red border + red background
    4. Expected: Shows "â° ×‘××™×—×•×¨ X ×“×§×•×ª" where X = minutes since estimated end
    5. Expected: Shows "×”×™×” ×¦×¨×™×š ×œ×”×¡×ª×™×™× ×‘-HH:MM"

    **Test Scenario 2: Create task near deadline (will be yellow)**
    1. Create new task:
       - Start time: 5 minutes ago
       - Duration: 10 minutes
    2. Expected: Task has yellow left border (no red background)
    3. Expected: Shows "âš ï¸ × ×©××¨×• X ×“×§×•×ª" (should be ~5 minutes)

    **Test Scenario 3: Create task with time remaining (green/on-time)**
    1. Create new task:
       - Start time: Now or future
       - Duration: 30 minutes
    2. Expected: No red/yellow border (normal styling)
    3. Expected: Shows "âœ… × ×©××¨×• X ×“×§×•×ª"
    4. Expected: Shows "×¡×™×•× ××•×¢×¨×š: HH:MM"

    **Test Scenario 4: Complete a late task**
    1. Find the late task from Scenario 1
    2. Send via WhatsApp or manually set status to 'completed'
    3. Expected: Red border/background removed (becomes normal completed task)
    4. Expected: Shows completion variance: "××™×—×•×¨ ×©×œ X ×“×§×•×ª" or "×”×•×©×œ× ××•×§×“× ×‘-X ×“×§×•×ª"
    5. Expected: Emoji changes (ğŸ‰ for early, â±ï¸ for late, âœ… for on-time)

    **Test Scenario 5: Auto-refresh countdown**
    1. Keep browser open with tasks displayed
    2. Wait 60 seconds without refreshing page
    3. Expected: Countdown numbers update (e.g., "× ×©××¨×• 29 ×“×§×•×ª" becomes "× ×©××¨×• 28 ×“×§×•×ª")
    4. Expected: Task that crosses deadline automatically turns red

    **Test Scenario 6: Real-time updates**
    1. Open two browser tabs side-by-side
    2. In Tab 1, create a late task
    3. Expected: Tab 2 immediately shows the new late task with red styling (via WebSocket)

    **Visual checks:**
    - Late tasks clearly stand out with red left border + red background
    - Yellow border visible for near-deadline tasks
    - Timing section displays below employee section, above completion data section
    - Hebrew text displays correctly (right-to-left)
    - Emojis render correctly (â°, âš ï¸, âœ…, ğŸ‰, â±ï¸)
    - No console errors in DevTools

    **Success criteria from ROADMAP.md:**
    1. âœ… ×× ×”×œ ×™×•×¦×¨ ××©×™××” ×¢× ×–××Ÿ ×”×ª×—×œ×” 08:00 ×•××©×š ××•×¢×¨×š 30 ×“×§×•×ª - ×‘×××©×§ ×¨×•××™× "×¡×™×•× ××•×¢×¨×š: 08:30"
    2. âœ… ×”×©×¢×” 08:31 ×•×”×¢×•×‘×“ ×¢×“×™×™×Ÿ ×œ× ×¡×™×™× - ×›×¨×˜×™×¡ ×”××©×™××” ×”×•×¤×š ××“×•× ×•×¨×©×•× "×‘××™×—×•×¨ 1 ×“×§×•×ª"
    3. âœ… ×¢×•×‘×“ ××¡×™×™× ××©×™××” ×‘-08:35 - ×× ×”×œ ×¨×•××” "×”×•×©×œ× ×‘-08:35 (××™×—×•×¨ ×©×œ 5 ×“×§×•×ª)"
    4. âœ… ×‘×××©×§ ×”×™×•× ×× ×”×œ ×¨×•××” 3 ××©×™××•×ª ×™×¨×•×§×•×ª (×‘×–××Ÿ), 2 ××“×•××•×ª (×‘××™×—×•×¨), 1 ×›×ª×•××” (×‘×‘×™×¦×•×¢ ×§×¨×•×‘ ×œ×¡×™×•×)
    5. âœ… ××©×™××” ×©×”×•×©×œ××” ×œ×¤× ×™ ×”×–××Ÿ (08:20) ××¦×™×’×” "×”×•×©×œ× ××•×§×“× ×‘-10 ×“×§×•×ª"
  </how-to-verify>
  <resume-signal>
    Type "approved" if all verification tests pass and UI displays timing correctly.

    If issues found, describe what's broken and I'll fix before continuing.
  </resume-signal>
</task>

</tasks>

<verification>
1. TaskCard displays timing section with countdown/overdue text
2. Late tasks have red left border + red background (bg-red-50)
3. Near-deadline tasks have yellow left border
4. Completed tasks show time variance with appropriate emoji and color
5. MyDayPage updates every 60 seconds via setInterval
6. All 5 success criteria from ROADMAP.md are met
7. No console errors, UI renders cleanly
8. Real-time updates work (timing data in Socket.IO events)
</verification>

<success_criteria>
1. Manager sees red-highlighted late tasks immediately upon page load
2. Countdown timers update every minute without page reload
3. Completed tasks display "×”×•×©×œ× ××•×§×“×" or "××™×—×•×¨ ×©×œ X ×“×§×•×ª" accurately
4. Near-deadline tasks (< 10 min remaining) show yellow indicator
5. All Phase 3 requirements satisfied (TS-01 through TS-08)
6. Visual design matches Phase 2 quality (consistent with existing TaskCard styling)
7. Hebrew text displays correctly in all timing messages
</success_criteria>

<output>
After completion, create `.planning/phases/03-status-tracking-timing/03-03-SUMMARY.md` documenting:
- Timing display implementation in TaskCard
- Red/yellow styling for late/near-deadline tasks
- Auto-refresh mechanism in MyDayPage
- Verification test results
- Any deviations from plan
- Requirements satisfied: TS-05 (red styling), TS-08 (countdown display)
- Phase 3 completion confirmation
</output>
