---
phase: 04-history-archive
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - client/src/pages/HistoryPage.jsx
  - client/src/components/history/HistoryFilters.jsx
  - client/src/components/history/HistoryStats.jsx
  - client/src/components/history/HistoryTable.jsx
  - client/src/hooks/useHistoryFilters.js
  - client/src/App.jsx
  - client/package.json
autonomous: true

must_haves:
  truths:
    - "Manager navigates to /history and sees completed tasks from last 7 days"
    - "Manager selects date range and sees only tasks completed in that range"
    - "Manager selects employee filter and sees only that employee's completed tasks"
    - "Statistics display shows total completed, late count, on-time percentage"
  artifacts:
    - path: "client/src/pages/HistoryPage.jsx"
      provides: "Main history page with filters, stats, and results"
      min_lines: 100
    - path: "client/src/hooks/useHistoryFilters.js"
      provides: "URL-based filter state management"
      exports: ["useHistoryFilters"]
      min_lines: 30
    - path: "client/src/components/history/HistoryFilters.jsx"
      provides: "Filter controls (date range, employee, system, location)"
      min_lines: 80
  key_links:
    - from: "HistoryPage.jsx"
      to: "/api/history"
      via: "fetch with URL search params"
      pattern: "fetch.*api/history.*searchParams"
    - from: "HistoryFilters.jsx"
      to: "useHistoryFilters hook"
      via: "updateFilter callback"
      pattern: "updateFilter.*searchParams"
    - from: "App.jsx"
      to: "HistoryPage.jsx"
      via: "React Router route"
      pattern: "<Route path=\"/history\""
---

<objective>
Provide manager UI for viewing, filtering, and analyzing completed task history with shareable/bookmarkable filtered views.

Purpose: Enable managers to search historical tasks by multiple criteria, view completion statistics, and share specific filtered views with colleagues.

Output: Complete history page with date range picker, multi-filter controls, statistics dashboard, and URL-based filter persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-history-archive/04-RESEARCH.md

# Backend API created in 04-01
@.planning/phases/04-history-archive/04-01-SUMMARY.md

# Existing UI patterns
@client/src/pages/MyDayPage.jsx
@client/src/components/shared/TaskCard.jsx
@client/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Date Picker Library and Create URL-Based Filter Hook</name>
  <files>client/package.json, client/src/hooks/useHistoryFilters.js</files>
  <action>
Install react-tailwindcss-datepicker (per RESEARCH.md standard stack):
```bash
cd client
npm install react-tailwindcss-datepicker
```

Create client/src/hooks/useHistoryFilters.js with URL-based state management:

```javascript
import { useSearchParams } from 'react-router-dom';

export function useHistoryFilters() {
  const [searchParams, setSearchParams] = useSearchParams();

  // Parse filters from URL
  const filters = {
    startDate: searchParams.get('start') || '',
    endDate: searchParams.get('end') || '',
    employeeId: searchParams.get('employee') || '',
    systemId: searchParams.get('system') || '',
    locationId: searchParams.get('location') || '',
  };

  // Update single filter
  const updateFilter = (key, value) => {
    const newParams = new URLSearchParams(searchParams);
    if (value) {
      newParams.set(key, value);
    } else {
      newParams.delete(key);
    }
    newParams.delete('offset'); // Reset pagination on filter change
    setSearchParams(newParams);
  };

  // Clear all filters
  const clearFilters = () => {
    setSearchParams(new URLSearchParams());
  };

  return { filters, updateFilter, clearFilters };
}
```

Why URL-based state (per RESEARCH.md Pattern 3):
- Shareable: Copy URL to share exact filtered view with colleague
- Bookmarkable: Save specific filter combinations
- Browser back/forward: Navigate filter history
- Persistence: Filters survive page refresh

Pattern: Follow RESEARCH.md Pattern 3 (URL-Based Filter State Management).

Verify hook works:
```javascript
// In HistoryPage component
const { filters, updateFilter } = useHistoryFilters();
console.log(filters); // Should reflect URL params
```
  </action>
  <verify>
- npm install succeeds without errors
- react-tailwindcss-datepicker appears in package.json dependencies
- useHistoryFilters.js exports hook correctly
- Hook reads URL parameters into filters object
- updateFilter modifies URL and triggers re-render
- clearFilters removes all URL parameters
  </verify>
  <done>
react-tailwindcss-datepicker installed, useHistoryFilters hook created with URL-based state management, filters sync with URL query parameters, shareable/bookmarkable URLs work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create History Filter Components (Date Range, Employee, System, Location)</name>
  <files>client/src/components/history/HistoryFilters.jsx, client/src/components/history/HistoryStats.jsx</files>
  <action>
Create client/src/components/history/HistoryFilters.jsx:

Component structure:
- Accept props: filters, employees[], systems[], locations[], onFilterChange, onClear
- Display filter controls in responsive grid (1 col mobile, 2 col md, 3 col lg)
- Use Datepicker from react-tailwindcss-datepicker for date range
- Dropdowns for employee, system, location (with "הכל" option)
- Clear filters button

Implementation (per RESEARCH.md code examples):
```javascript
import Datepicker from 'react-tailwindcss-datepicker';

export default function HistoryFilters({ filters, employees, systems, locations, onFilterChange, onClear }) {
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-6">
      <h2 className="font-semibold mb-4">סינון</h2>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {/* Date Range Picker */}
        <div>
          <label className="block text-sm font-medium mb-2">טווח תאריכים</label>
          <Datepicker
            value={{
              startDate: filters.startDate,
              endDate: filters.endDate
            }}
            onChange={(newValue) => {
              onFilterChange('start', newValue?.startDate || '');
              onFilterChange('end', newValue?.endDate || '');
            }}
            displayFormat="DD/MM/YYYY"
            i18n="he"
            placeholder="בחר טווח תאריכים"
          />
        </div>

        {/* Employee Filter */}
        <div>
          <label className="block text-sm font-medium mb-2">עובד</label>
          <select
            value={filters.employeeId}
            onChange={(e) => onFilterChange('employee', e.target.value)}
            className="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="">כל העובדים</option>
            {employees.map(emp => (
              <option key={emp.id} value={emp.id}>{emp.name}</option>
            ))}
          </select>
        </div>

        {/* System Filter */}
        <div>
          <label className="block text-sm font-medium mb-2">מערכת</label>
          <select
            value={filters.systemId}
            onChange={(e) => onFilterChange('system', e.target.value)}
            className="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="">כל המערכות</option>
            {systems.map(sys => (
              <option key={sys.id} value={sys.id}>{sys.name}</option>
            ))}
          </select>
        </div>

        {/* Location Filter */}
        <div>
          <label className="block text-sm font-medium mb-2">מיקום</label>
          <select
            value={filters.locationId}
            onChange={(e) => onFilterChange('location', e.target.value)}
            className="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="">כל המיקומים</option>
            {locations.map(loc => (
              <option key={loc.id} value={loc.id}>{loc.name}</option>
            ))}
          </select>
        </div>
      </div>

      <button
        onClick={onClear}
        className="mt-4 px-4 py-2 text-sm text-gray-600 hover:text-gray-900 underline"
      >
        נקה סינון
      </button>
    </div>
  );
}
```

Create client/src/components/history/HistoryStats.jsx:

Component structure:
- Accept props: stats { total_completed, total_late, on_time_percentage }
- Display 3 stat cards in responsive grid
- Use Tailwind color classes: green for success rate, red for late count

```javascript
export default function HistoryStats({ stats }) {
  if (!stats) return null;

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-6">
      <h2 className="font-semibold mb-4">סטטיסטיקות</h2>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="text-center">
          <p className="text-gray-600 text-sm mb-1">סך הכל הושלמו</p>
          <p className="text-3xl font-bold text-primary">{stats.total_completed}</p>
        </div>

        <div className="text-center">
          <p className="text-gray-600 text-sm mb-1">באיחור</p>
          <p className="text-3xl font-bold text-red-600">{stats.total_late}</p>
        </div>

        <div className="text-center">
          <p className="text-gray-600 text-sm mb-1">אחוז הצלחה</p>
          <p className="text-3xl font-bold text-green-600">
            {stats.on_time_percentage}%
          </p>
        </div>
      </div>
    </div>
  );
}
```

Both components use Hebrew labels and right-to-left layout per project conventions.
  </action>
  <verify>
- HistoryFilters.jsx renders with all filter controls
- Datepicker shows Hebrew labels and DD/MM/YYYY format
- Employee/System/Location dropdowns show "הכל" default option
- Clear button removes all filters
- HistoryStats.jsx displays 3 stat cards with correct styling
- Components are responsive (1 col mobile, 3 col desktop)
  </verify>
  <done>
HistoryFilters component exists with date range picker and all filter dropdowns, HistoryStats component displays statistics with color-coded cards, both components use Hebrew labels and RTL layout, responsive grid layouts work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create History Table and Main Page with Routing</name>
  <files>client/src/components/history/HistoryTable.jsx, client/src/pages/HistoryPage.jsx, client/src/App.jsx</files>
  <action>
Create client/src/components/history/HistoryTable.jsx:

Component structure:
- Accept props: tasks[], loading boolean
- Display task list with completion details
- Show: title, employee name, system name, completion date, late/on-time indicator
- Use same TaskCard styling pattern as MyDayPage for consistency
- Display Hebrew time_delta_text for completed tasks

```javascript
import { format } from 'date-fns';
import { he } from 'date-fns/locale';

export default function HistoryTable({ tasks, loading }) {
  if (loading) {
    return <div className="p-8 text-center text-gray-500">טוען...</div>;
  }

  if (tasks.length === 0) {
    return <div className="p-8 text-center text-gray-500">לא נמצאו משימות</div>;
  }

  return (
    <div className="bg-white rounded-lg shadow divide-y">
      {tasks.map((task) => (
        <div key={task.id} className="p-4 hover:bg-gray-50 transition-colors">
          <div className="flex justify-between items-start">
            <div className="flex-1">
              <h3 className="font-semibold text-lg mb-1">{task.title}</h3>
              <div className="flex flex-wrap gap-2 text-sm text-gray-600">
                <span>עובד: {task.employee_name}</span>
                <span>•</span>
                <span>מערכת: {task.system_name}</span>
                {task.location_name && (
                  <>
                    <span>•</span>
                    <span>מיקום: {task.location_name}</span>
                  </>
                )}
              </div>
              {task.completion_note && (
                <p className="text-sm text-gray-600 mt-2">
                  <strong>הערה:</strong> {task.completion_note}
                </p>
              )}
            </div>

            <div className="text-left mr-4">
              <p className="text-sm text-gray-600 mb-1">
                {format(new Date(task.completed_at), 'dd/MM/yyyy HH:mm', { locale: he })}
              </p>
              {task.time_delta_minutes !== null && (
                <span className={`text-sm font-medium ${
                  task.time_delta_minutes > 0 ? 'text-red-600' : 'text-green-600'
                }`}>
                  {task.time_delta_text}
                </span>
              )}
            </div>
          </div>
        </div>
      ))}
    </div>
  );
}
```

Create client/src/pages/HistoryPage.jsx:

Main page structure:
- Use useHistoryFilters hook for URL state
- Fetch employees, systems, locations for filter dropdowns
- Fetch history data when filters change
- Display HistoryStats, HistoryFilters, HistoryTable components

```javascript
import { useState, useEffect } from 'react';
import { useHistoryFilters } from '../hooks/useHistoryFilters';
import HistoryFilters from '../components/history/HistoryFilters';
import HistoryStats from '../components/history/HistoryStats';
import HistoryTable from '../components/history/HistoryTable';

export default function HistoryPage() {
  const { filters, updateFilter, clearFilters } = useHistoryFilters();
  const [tasks, setTasks] = useState([]);
  const [stats, setStats] = useState(null);
  const [employees, setEmployees] = useState([]);
  const [systems, setSystems] = useState([]);
  const [locations, setLocations] = useState([]);
  const [loading, setLoading] = useState(false);

  // Fetch filter options on mount
  useEffect(() => {
    fetch('/api/employees').then(r => r.json()).then(setEmployees);
    fetch('/api/systems').then(r => r.json()).then(setSystems);
    fetch('/api/locations').then(r => r.json()).then(setLocations);
  }, []);

  // Fetch history when filters change
  useEffect(() => {
    const fetchHistory = async () => {
      setLoading(true);
      try {
        const queryString = new URLSearchParams(
          Object.fromEntries(
            Object.entries(filters).filter(([_, v]) => v !== '')
          )
        ).toString();

        const response = await fetch(`/api/history?${queryString}`);
        const data = await response.json();

        setTasks(data.tasks);
        setStats(data.stats);
      } catch (error) {
        console.error('Failed to fetch history:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchHistory();
  }, [filters]);

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">היסטוריית משימות</h1>

      <HistoryStats stats={stats} />

      <HistoryFilters
        filters={filters}
        employees={employees}
        systems={systems}
        locations={locations}
        onFilterChange={updateFilter}
        onClear={clearFilters}
      />

      <HistoryTable tasks={tasks} loading={loading} />
    </div>
  );
}
```

Add route to client/src/App.jsx:

In the Routes section (after other pages):
```javascript
import HistoryPage from './pages/HistoryPage';

// Inside <Routes>
<Route path="/history" element={<HistoryPage />} />
```

Add sidebar navigation link (if Sidebar.jsx has nav menu):
- Icon: FaHistory or FaClockRotateLeft
- Label: "היסטוריה"
- Path: "/history"

Pattern: Follow RESEARCH.md Pattern 3 (URL state) and existing page structure from MyDayPage.jsx.
  </action>
  <verify>
Test history page functionality:
- Navigate to /history - page loads with last 7 days of completed tasks
- Select date range 01/01/2025 - 31/01/2025 - URL updates, tasks filtered
- Select employee from dropdown - URL updates, only that employee's tasks shown
- Click "נקה סינון" - all filters clear, URL resets, all tasks shown
- Statistics show correct numbers with decimal percentage
- Refresh page - filters persist from URL
- Copy URL and open in new tab - same filtered view appears
- Browser back button - returns to previous filter state
  </verify>
  <done>
HistoryTable component displays completed tasks with completion details, HistoryPage integrates all components with URL-based filtering, route exists at /history, filters sync with URL for shareable views, statistics display correctly, page is responsive and uses Hebrew labels.
  </done>
</task>

</tasks>

<verification>
Frontend history interface complete when:
1. Manager navigates to /history and sees last 7 days of completed tasks
2. Date range picker allows selection and filters correctly
3. Employee/System/Location dropdowns filter results
4. Statistics show: total completed, late count, on-time percentage
5. URL reflects current filters (shareable/bookmarkable)
6. Clear filters button resets view
7. Task list shows completion date, time variance, notes
8. Responsive layout works on mobile and desktop
</verification>

<success_criteria>
- Manager clicks "היסטוריה" in sidebar, sees history page with tasks
- Selects "01/01/2025 - 31/01/2025" date range, sees only January tasks
- Selects employee "יוסי", sees only יוסי's completed tasks
- Statistics header shows "102 משימות הושלמו, 12 באיחור (88.2% בזמן)"
- Copies URL, shares with colleague, colleague sees exact same filtered view
- Clicks clear filters, all tasks return, URL resets
- Late tasks show red "איחור של X דקות", early tasks show green "הושלם מוקדם"
</success_criteria>

<output>
After completion, create `.planning/phases/04-history-archive/04-02-SUMMARY.md` documenting:
- HistoryPage component structure and data flow
- URL-based filter state pattern
- Date picker integration
- Component composition (Stats, Filters, Table)
- Routing setup
</output>
