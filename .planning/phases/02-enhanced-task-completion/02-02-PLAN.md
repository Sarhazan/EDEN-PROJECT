---
phase: 02-enhanced-task-completion
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - server/services/htmlGenerator.js
  - server/routes/tasks.js
  - client/src/components/shared/TaskCard.jsx
  - client/src/components/shared/Modal.jsx
  - client/src/index.css
  - client/src/context/AppContext.jsx
autonomous: false

must_haves:
  truths:
    - "Worker sees image upload input and note textarea on confirmation page"
    - "Mobile worker can capture photo directly from camera"
    - "Desktop worker can select image from file system"
    - "Submitted image and note appear in manager's TaskCard immediately"
    - "Manager can click thumbnail to view full-size image in lightbox"
    - "Lightbox closes when clicking outside image"
  artifacts:
    - path: "server/services/htmlGenerator.js"
      provides: "Updated HTML template with image upload form"
      contains: "input type=\"file\""
    - path: "server/routes/tasks.js"
      provides: "GET /api/tasks/:id/attachments endpoint"
      exports: ["router"]
    - path: "client/src/components/shared/TaskCard.jsx"
      provides: "Image thumbnails and lightbox display"
      contains: "task_attachments"
    - path: "client/src/components/shared/Modal.jsx"
      provides: "Lightbox modal for full-size images"
      contains: "lightbox"
  key_links:
    - from: "docs/task-*.html"
      to: "POST /api/confirm/:token/complete"
      via: "FormData upload"
      pattern: "new FormData\\(\\)"
    - from: "client/src/components/shared/TaskCard.jsx"
      to: "task.attachments"
      via: "map over attachments array"
      pattern: "\\.map\\(.*attachment"
    - from: "client/src/components/shared/TaskCard.jsx"
      to: "Modal component"
      via: "lightbox state toggle"
      pattern: "setLightbox"
    - from: "server/index.js"
      to: "server/routes/tasks.js"
      via: "router mounting at /api/tasks"
      pattern: "app\\.use\\('/api/tasks'.*require.*tasks"
---

<objective>
Add image upload UI to confirmation pages and display images/notes in manager interface.

Purpose: Workers need visual UI to submit completion data from their phones or computers. Managers need to see evidence and notes in the admin interface immediately.

Output: Updated HTML template with mobile-friendly upload form, TaskCard component showing thumbnails with lightbox preview, real-time display of completion data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-enhanced-task-completion/02-RESEARCH.md

# Prior phase summaries
@.planning/phases/01-real-time-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-real-time-infrastructure/01-02-SUMMARY.md

# Dependency
@.planning/phases/02-enhanced-task-completion/02-01-SUMMARY.md

# Codebase context
@server/services/htmlGenerator.js
@server/routes/tasks.js
@client/src/components/shared/TaskCard.jsx
@client/src/components/shared/Modal.jsx
@client/src/context/AppContext.jsx
</context>

<tasks>

<task type="auto">
  <name>Add image upload form to static HTML confirmation pages</name>
  <files>
    server/services/htmlGenerator.js
  </files>
  <action>
Add image input and note textarea to task completion section in HTML template.

**Locate completion section in template:**
Find the section that shows tasks with checkboxes (around line 350-450 in the template string). Look for where task status is toggled on checkbox click.

**1. Add completion form HTML after each task card:**

Inside the task card div (after task-meta div), add:

```html
<div class="completion-form" id="completion-form-\${task.id}" style="display: none;">
  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
    <h3 style="font-size: 16px; margin-bottom: 10px; color: #1f2937;">פרטי השלמה</h3>

    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">
        צלם תמונה:
      </label>
      <input
        type="file"
        accept="image/*"
        capture="environment"
        id="image-\${task.id}"
        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;"
      />
      <div style="font-size: 12px; color: #6b7280; margin-top: 3px;">
        עד 5MB, JPG או PNG בלבד
      </div>
    </div>

    <div style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">
        הערות (אופציונלי):
      </label>
      <textarea
        id="note-\${task.id}"
        rows="3"
        placeholder="הוסף הערות על המשימה..."
        style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical; font-family: inherit;"
      ></textarea>
    </div>

    <button
      onclick="submitCompletion(\${task.id})"
      style="width: 100%; padding: 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;"
    >
      שלח השלמה
    </button>

    <div id="completion-status-\${task.id}" style="margin-top: 10px; text-align: center; font-size: 14px;"></div>
  </div>
</div>
```

**2. Modify checkbox handler to show/hide completion form:**

Find the checkbox onchange handler. Replace simple status toggle with:

```javascript
function toggleTaskCompletion(taskId, checkbox) {
  const completionForm = document.getElementById('completion-form-' + taskId);

  if (checkbox.checked) {
    // Show completion form when checked
    completionForm.style.display = 'block';
  } else {
    // Hide form when unchecked
    completionForm.style.display = 'none';
  }
}
```

Update checkbox element to call this function:
```html
<input
  type="checkbox"
  class="checkbox"
  onchange="toggleTaskCompletion(\${task.id}, this)"
  \${task.status === 'completed' ? 'checked disabled' : ''}
/>
```

**3. Add submitCompletion JavaScript function:**

Add this function in the `<script>` section (around line 500):

```javascript
async function submitCompletion(taskId) {
  const imageInput = document.getElementById('image-' + taskId);
  const noteInput = document.getElementById('note-' + taskId);
  const statusDiv = document.getElementById('completion-status-' + taskId);

  // Create FormData (RESEARCH.md Pattern 2)
  const formData = new FormData();
  formData.append('taskId', taskId);

  if (noteInput.value.trim()) {
    formData.append('note', noteInput.value.trim());
  }

  if (imageInput.files.length > 0) {
    formData.append('image', imageInput.files[0]);
  }

  // Show loading state
  statusDiv.innerHTML = '<span style="color: #3b82f6;">שולח...</span>';

  try {
    const response = await fetch(\`\${API_URL}/api/confirm/\${TOKEN}/complete\`, {
      method: 'POST',
      body: formData
      // CRITICAL: Do NOT set Content-Type header (RESEARCH.md Pitfall 2)
    });

    const result = await response.json();

    if (response.ok && result.success) {
      statusDiv.innerHTML = '<span style="color: #10b981; font-weight: 600;">✓ המשימה הושלמה בהצלחה!</span>';

      // Disable form after successful submission
      const checkbox = document.querySelector(\`input[onchange*="toggleTaskCompletion(\${taskId}"]\`);
      if (checkbox) {
        checkbox.disabled = true;
      }
      imageInput.disabled = true;
      noteInput.disabled = true;

      // Hide submit button
      event.target.style.display = 'none';
    } else {
      statusDiv.innerHTML = '<span style="color: #ef4444;">שגיאה: ' + result.error + '</span>';
    }
  } catch (error) {
    console.error('Error submitting completion:', error);
    statusDiv.innerHTML = '<span style="color: #ef4444;">שגיאה בשליחת הנתונים</span>';
  }
}
```

**Why capture="environment":**
- Launches rear camera on Android automatically (RESEARCH.md Pattern 3)
- iOS shows choice between camera and photo library
- Desktop browsers ignore attribute and show file picker
- Optimized for field workers taking photos of completed work

**Why accept="image/*":**
- Restricts file picker to images only
- Mobile devices show camera/gallery options
- Desktop shows filtered file picker

**Critical: No Content-Type header:**
- FormData automatically sets correct multipart/form-data with boundary
- Manually setting breaks the upload (RESEARCH.md Pitfall 2)
  </action>
  <verify>
1. Run `npm run dev` to start dev server
2. Create test task and send via WhatsApp (or access docs/task-*.html directly)
3. Open confirmation page on mobile browser (or Chrome DevTools mobile emulator)
4. Check checkbox next to a task
5. Verify completion form appears with:
   - File input with "צלם תמונה" label
   - Textarea with "הערות" label
   - "שלח השלמה" button
6. Select an image (or use camera on mobile)
7. Add note text
8. Click "שלח השלמה"
9. Verify success message appears
10. Check browser network tab: POST request with multipart/form-data Content-Type
  </verify>
  <done>
- Completion form exists in HTML template after each task card
- Form hidden by default, shows when checkbox checked
- File input has accept="image/*" and capture="environment"
- Textarea accepts free-form Hebrew notes
- submitCompletion() function creates FormData and POSTs to /api/confirm/:token/complete
- No Content-Type header set manually (browser handles multipart boundary)
- Success message shown after upload completes
- Form disabled after successful submission
  </done>
</task>

<task type="auto">
  <name>Display images and notes in manager TaskCard with lightbox preview</name>
  <files>
    server/routes/tasks.js
    client/src/components/shared/TaskCard.jsx
    client/src/components/shared/Modal.jsx
    client/src/index.css
    client/src/context/AppContext.jsx
  </files>
  <action>
Add image thumbnails and notes display to TaskCard, with lightbox modal for full-size image viewing.

**1. Create API endpoint for fetching attachments:**

In `server/routes/tasks.js`, add GET endpoint for attachments:

```javascript
// Get attachments for a task
router.get('/:id/attachments', (req, res) => {
  try {
    const { id } = req.params;

    const attachments = db.prepare(\`
      SELECT id, task_id, file_path, file_type, uploaded_at
      FROM task_attachments
      WHERE task_id = ?
      ORDER BY uploaded_at DESC
    \`).all(id);

    res.json(attachments);
  } catch (error) {
    console.error('Error fetching attachments:', error);
    res.status(500).json({ error: 'שגיאה בטעינת קבצים מצורפים' });
  }
});
```

**CRITICAL: Verify router mounting in server/index.js**

Check that `server/index.js` has the tasks router mounted. Look for:

```javascript
app.use('/api/tasks', require('./routes/tasks'));
```

If missing, add this line after other route registrations (around line 70). The tasks router must be mounted at `/api/tasks` for the GET /api/tasks/:id/attachments endpoint to be accessible.

**2. Fetch attachments in AppContext:**

In `client/src/context/AppContext.jsx`, update fetchTasks to include attachments:

Find the fetchTasks function (around line 50). Modify to:

```javascript
const fetchTasks = async () => {
  try {
    const response = await fetch(\`\${API_URL}/api/tasks\`);
    const tasksData = await response.json();

    // Fetch attachments for each task
    const tasksWithAttachments = await Promise.all(
      tasksData.map(async (task) => {
        const attachmentsResponse = await fetch(\`\${API_URL}/api/tasks/\${task.id}/attachments\`);
        const attachments = await attachmentsResponse.json();
        return { ...task, attachments };
      })
    );

    setTasks(tasksWithAttachments);
  } catch (error) {
    console.error('Error fetching tasks:', error);
  }
};
```

**3. Update TaskCard to display completion data:**

In `client/src/components/shared/TaskCard.jsx`, find the task-meta section (around line 80).

After the task-meta div, add completion section:

```javascript
{/* Completion data section */}
{(task.completion_note || (task.attachments && task.attachments.length > 0)) && (
  <div className="completion-section" style={{
    marginTop: '15px',
    paddingTop: '15px',
    borderTop: '1px solid #e5e7eb'
  }}>
    <h4 style={{
      fontSize: '14px',
      fontWeight: '600',
      color: '#374151',
      marginBottom: '10px'
    }}>
      פרטי השלמה:
    </h4>

    {/* Display note */}
    {task.completion_note && (
      <div className="completion-note" style={{
        background: '#fef3c7',
        padding: '10px',
        borderRadius: '6px',
        marginBottom: '10px',
        fontSize: '14px',
        lineHeight: '1.5'
      }}>
        <strong>הערה:</strong> {task.completion_note}
      </div>
    )}

    {/* Display images */}
    {task.attachments && task.attachments.filter(a => a.file_type === 'image').length > 0 && (
      <div className="completion-images">
        <div style={{
          display: 'flex',
          gap: '10px',
          flexWrap: 'wrap'
        }}>
          {task.attachments
            .filter(a => a.file_type === 'image')
            .map((attachment) => (
              <img
                key={attachment.id}
                src={\`\${API_URL}\${attachment.file_path}\`}
                alt="תמונת השלמה"
                className="thumbnail"
                onClick={() => setLightboxImage(\`\${API_URL}\${attachment.file_path}\`)}
                style={{
                  width: '80px',
                  height: '80px',
                  objectFit: 'cover',
                  borderRadius: '6px',
                  cursor: 'pointer',
                  border: '2px solid #d1d5db',
                  transition: 'transform 0.2s'
                }}
                onMouseEnter={(e) => e.target.style.transform = 'scale(1.05)'}
                onMouseLeave={(e) => e.target.style.transform = 'scale(1)'}
              />
            ))}
        </div>
      </div>
    )}
  </div>
)}
```

**4. Add lightbox state to TaskCard:**

At top of TaskCard component, add:

```javascript
import { useState } from 'react';

export default function TaskCard({ task, onEdit, onDelete }) {
  const [lightboxImage, setLightboxImage] = useState(null);

  // ... rest of component
```

After the return JSX, add lightbox modal at the end (before closing component):

```javascript
{/* Lightbox modal */}
{lightboxImage && (
  <div
    className="lightbox-overlay"
    onClick={() => setLightboxImage(null)}
    style={{
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      background: 'rgba(0, 0, 0, 0.9)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 9999,
      cursor: 'pointer'
    }}
  >
    <img
      src={lightboxImage}
      alt="תצוגה מלאה"
      onClick={(e) => e.stopPropagation()}
      style={{
        maxWidth: '90%',
        maxHeight: '90%',
        objectFit: 'contain',
        cursor: 'default'
      }}
    />
  </div>
)}
```

**5. Add lightbox styles to index.css:**

In `client/src/index.css`, add:

```css
/* Lightbox styles */
.lightbox-overlay {
  animation: fadeIn 0.2s ease-in;
}

.lightbox-overlay img {
  animation: zoomIn 0.3s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes zoomIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.thumbnail:hover {
  transform: scale(1.05);
}
```

**6. Update WebSocket listener to fetch attachments:**

In `client/src/context/AppContext.jsx`, update task:updated listener:

```javascript
socket.on('task:updated', async (data) => {
  console.log('Task updated via WebSocket:', data.task);

  // Fetch attachments for updated task
  try {
    const attachmentsResponse = await fetch(\`\${API_URL}/api/tasks/\${data.task.id}/attachments\`);
    const attachments = await attachmentsResponse.json();
    data.task.attachments = attachments;
  } catch (error) {
    console.error('Error fetching attachments for updated task:', error);
  }

  setTasks(prevTasks => {
    const index = prevTasks.findIndex(t => t.id === data.task.id);
    if (index !== -1) {
      const newTasks = [...prevTasks];
      newTasks[index] = data.task;
      return newTasks;
    }
    return prevTasks;
  });
});
```

**Why 80px thumbnails:**
- Large enough to see image content
- Small enough to show multiple images
- Mobile-friendly touch targets (>44px)

**Why lightbox on fixed overlay:**
- Full-screen viewing without navigation
- Dark background focuses attention on image
- Click outside to close is intuitive UX
- No external library needed (RESEARCH.md Pattern 5)

**Why fetch attachments separately:**
- Tasks table doesn't have attachments (separate table)
- Avoid JOIN overhead for all tasks
- Lazy load only when needed
- Easier to update in real-time
  </action>
  <verify>
1. Run `npm run dev` in both client and server
2. Complete a task from confirmation page with image and note
3. Open manager interface (should already be open from prior testing)
4. Verify TaskCard shows:
   - Yellow note box with "הערה:" label and note text
   - Image thumbnail (80x80px) with border
   - "פרטי השלמה:" heading above completion section
5. Hover over thumbnail - verify scale effect
6. Click thumbnail - verify lightbox opens with full-size image
7. Verify lightbox has dark background (rgba(0,0,0,0.9))
8. Click outside image - verify lightbox closes
9. Open in second browser tab - verify both tabs show completion data in real-time
  </verify>
  <done>
- GET /api/tasks/:id/attachments endpoint created in server/routes/tasks.js
- Tasks router verified mounted at /api/tasks in server/index.js
- TaskCard displays completion_note in yellow box when present
- TaskCard displays image thumbnails (80x80px) when attachments exist
- Thumbnails have hover effect (scale 1.05)
- Clicking thumbnail opens lightbox modal with full-size image
- Lightbox overlay covers full viewport with dark background
- Clicking outside image closes lightbox
- AppContext fetches attachments for all tasks on mount
- WebSocket task:updated listener fetches attachments for updated task
- Real-time updates show completion data immediately in all open tabs
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete image upload and notes feature from worker confirmation page to manager interface with real-time updates and lightbox preview.
  </what-built>
  <how-to-verify>
**Test the full completion flow:**

1. **Start both servers:**
   - Terminal 1: `cd server && npm start` (port 3002)
   - Terminal 2: `cd client && npm run dev` (port 5173)

2. **Open manager interface:**
   - Navigate to http://localhost:5173
   - Verify connection status shows "מחובר" in sidebar

3. **Create and send a test task:**
   - Create a new task for an employee with WhatsApp
   - Click "שלח משימות" to send via WhatsApp
   - Copy the confirmation page URL from WhatsApp message

4. **Test on mobile (real device or emulator):**
   - Open confirmation URL in Chrome DevTools mobile emulator
   - Check the checkbox for the task
   - Verify completion form appears with:
     - File input labeled "צלם תמונה"
     - Textarea labeled "הערות (אופציונלי)"
     - "שלח השלמה" button
   - Click file input - verify camera launches (or file picker on desktop)
   - Select/capture a test image
   - Type a note: "בדיקה - המשימה הושלמה"
   - Click "שלח השלמה"
   - Verify success message: "✓ המשימה הושלמה בהצלחה!"

5. **Verify real-time update in manager interface:**
   - Switch to manager interface tab
   - Verify the task card updates immediately (without page refresh) showing:
     - Yellow note box with: "הערה: בדיקה - המשימה הושלמה"
     - Image thumbnail (80x80px)
     - "פרטי השלמה:" heading

6. **Test lightbox:**
   - Hover over image thumbnail - verify scale effect
   - Click thumbnail
   - Verify lightbox opens showing full-size image on dark background
   - Click outside image - verify lightbox closes
   - Verify ESC key closes lightbox

7. **Test with multiple images (same task completed multiple times):**
   - If task is recurring, complete next instance with different image
   - Verify both thumbnails appear side by side

8. **Test edge cases:**
   - Submit completion with note but NO image - verify note appears
   - Submit completion with image but NO note - verify image appears
   - Try uploading non-image file (.txt) - verify error message
   - Try uploading >5MB image - verify error message

**Expected Results:**
- ✅ Completion form shows/hides on checkbox toggle
- ✅ Mobile camera launches with capture="environment"
- ✅ Image uploads successfully
- ✅ Note saves successfully
- ✅ Manager sees completion data in real-time (both tabs if multiple open)
- ✅ Thumbnails display with correct styling
- ✅ Lightbox works (open/close, full-size display)
- ✅ File validation rejects non-images and oversized files

**If issues found:**
- Check browser console for errors
- Check server logs for upload errors
- Verify uploads/ directory has write permissions
- Verify database has task_attachments table
- Check network tab for multipart/form-data request
  </how-to-verify>
  <resume-signal>
Type "approved" if verification passes, or describe any issues found with specifics (screenshots, error messages, browser console output).
  </resume-signal>
</task>

</tasks>

<verification>

**Static HTML Form:**
1. Open docs/task-*.html in browser
2. Verify completion form HTML exists with file input and textarea
3. Verify checkbox toggle shows/hides form
4. Verify FormData upload sends multipart request
5. Verify no Content-Type header set manually (check Network tab)

**Manager Interface:**
1. Verify TaskCard shows yellow note box when completion_note exists
2. Verify thumbnails display when attachments exist
3. Verify thumbnail hover effect works
4. Verify lightbox opens on thumbnail click
5. Verify lightbox closes on outside click
6. Verify real-time updates show completion data immediately

**Real-Time Integration:**
1. Complete task from confirmation page
2. Manager interface updates without refresh
3. Both completion note and image appear instantly
4. Multiple browser tabs all update simultaneously

**Cross-Browser:**
1. Test on Chrome (desktop and mobile DevTools)
2. Test on actual mobile device if available
3. Verify camera launches on mobile
4. Verify file picker works on desktop

</verification>

<success_criteria>

**Phase 2 Requirements Coverage:**
- ✅ TC-01: Worker can upload image from confirmation page (mobile/desktop)
- ✅ TC-02: Worker can add text note to task
- ✅ TC-03: Images stored as files in /uploads directory
- ✅ TC-04: Manager sees images and notes in admin interface
- ✅ TC-05: Images displayed as thumbnails with lightbox preview

**Measurable Outcomes:**
1. Worker checks task on confirmation page → completion form appears
2. Worker captures image on mobile → camera launches (capture="environment")
3. Worker types note and clicks "שלח השלמה" → success message appears
4. Manager interface updates in real-time showing note and thumbnail
5. Manager clicks thumbnail → lightbox opens with full-size image
6. Multiple manager tabs all see update simultaneously
7. Image file saved to uploads/ with unique hex filename
8. Database has task_attachments record with file_path
9. Database has tasks.completion_note with note text
10. File validation rejects non-images and oversized uploads

</success_criteria>

<output>
After completion, create `.planning/phases/02-enhanced-task-completion/02-02-SUMMARY.md` following the summary template.

Include:
- HTML template modifications (completion form)
- TaskCard enhancements (thumbnails, lightbox)
- Real-time integration verification
- Mobile testing results
- Screenshots of completion data display (if taken during verification)
- Any browser-specific quirks discovered
</output>
